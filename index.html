<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawCraft v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a15;
            color: #fff;
            overflow: hidden;
            font-size: 12px;
        }
        #gameContainer { display: flex; height: 100vh; }
        #canvasContainer { flex: 1; position: relative; overflow: hidden; }
        #gameCanvas { cursor: grab; display: block; }
        #gameCanvas:active { cursor: grabbing; }
        #sidebar {
            width: 320px;
            background: #1a1a2e;
            border-left: 2px solid #e94560;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        h1 { color: #e94560; font-size: 1.3em; margin-bottom: 8px; }
        h2 { color: #e94560; font-size: 1em; margin-bottom: 6px; }
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 5px 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 11px;
        }
        .res-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
        }
        .res-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: #e94560;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
        }
        button:hover { background: #ff6b6b; }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }
        button.active { background: #4a9; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 4px; }
        .mini-btn { padding: 4px 8px; font-size: 10px; background: #2a4a6a; }
        .mini-btn:hover { background: #3a5a8a; }
        #hexDetail { font-size: 11px; }
        .log {
            max-height: 80px;
            overflow-y: auto;
            background: #0a0a15;
            border-radius: 4px;
            padding: 6px;
            font-family: monospace;
            font-size: 10px;
        }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #1a1a2e; }
        .unit-item {
            padding: 4px 8px;
            margin: 2px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }
        .unit-item:hover { background: rgba(233, 69, 96, 0.3); }
        .unit-item.selected { background: #e94560; }
        .hp-bar {
            width: 60px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        .hp-fill {
            height: 100%;
            background: #4a9;
            border-radius: 3px;
        }
        .tick { color: #888; font-size: 10px; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div id="sidebar">
            <h1>ü¶û ClawCraft v2</h1>
            
            <div class="section">
                <h2>ËµÑÊ∫ê</h2>
                <div class="stat-row">
                    <span>‚ö° ËÉΩÈáè</span>
                    <span id="resE">0 / 0</span>
                </div>
                <div class="res-bar"><div class="res-fill" id="barE" style="width:0%; background:#fd0;"></div></div>
                
                <div class="stat-row" style="margin-top:8px;">
                    <span>ü™ô ÈªÑÈáë</span>
                    <span id="resG">0</span>
                </div>
                
                <div class="stat-row">
                    <span>üë§ Âçï‰Ωç</span>
                    <span id="resU">0 / 10</span>
                </div>
                
                <div class="tick" id="tickInfo">Tick: 0 | Áîü‰∫ß: +0E/s</div>
            </div>

            <div class="section">
                <h2>ÈÄâ‰∏≠Ê†ºÂ≠ê</h2>
                <div id="hexDetail">ÁÇπÂáªÂú∞ÂõæÊü•ÁúãËØ¶ÊÉÖ</div>
            </div>

            <div class="section">
                <h2>Âª∫ÈÄ†</h2>
                <div class="btn-group">
                    <button class="mini-btn" onclick="game.setBuild('mineE')">ËÉΩÈáèÁüø 50E</button>
                    <button class="mini-btn" onclick="game.setBuild('mineG')">ÈªÑÈáëÁüø 80E</button>
                    <button class="mini-btn" onclick="game.setBuild('storageE')">ËÉΩÈáè‰ªì 60E</button>
                    <button class="mini-btn" onclick="game.setBuild('tower')">Èò≤Âæ°Â°î 100E</button>
                </div>
                <button onclick="game.cancelBuild()" style="margin-top:6px;">ÂèñÊ∂à</button>
            </div>

            <div class="section">
                <h2>Âçï‰Ωç</h2>
                <div id="unitList">Êó†Âçï‰Ωç</div>
                <div class="btn-group" style="margin-top:8px;">
                    <button onclick="game.spawnUnit()">ÁîüÊàê 30E</button>
                    <button onclick="game.toggleMove()">ÁßªÂä®</button>
                    <button onclick="game.toggleGather()">ÈááÈõÜ</button>
                </div>
            </div>

            <div class="section">
                <h2>Êìç‰Ωú</h2>
                <div class="btn-group">
                    <button onclick="game.speed = game.speed === 1 ? 5 : 1">Âä†ÈÄü</button>
                    <button onclick="game.save()">‰øùÂ≠ò</button>
                    <button onclick="game.load()">Âä†ËΩΩ</button>
                    <button onclick="game.reset()">ÈáçÁΩÆ</button>
                </div>
            </div>

            <div class="section">
                <h2>Êó•Âøó</h2>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            MAP_W: 20, MAP_H: 20, HEX_SIZE: 28,
            TICK_RATE: 1000, MAX_UNITS: 10,
            START_E: 200, START_G: 50, MAX_STORAGE: 1000
        };

        const BUILDINGS = {
            mineE: { name: 'ËÉΩÈáèÁüø', cost: 50, prodE: 5, maxE: 200 },
            mineG: { name: 'ÈªÑÈáëÁüø', cost: 80, prodG: 2, maxG: 100 },
            storageE: { name: 'ËÉΩÈáè‰ªì', cost: 60, maxE: 500 },
            tower: { name: 'Èò≤Âæ°Â°î', cost: 100, attack: 10 }
        };

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.camera = { x: 0, y: 0, zoom: 1 };
                this.tick = 0;
                this.speed = 1;
                this.paused = false;
                
                this.resetData();
                this.setup();
                this.start();
            }

            resetData() {
                this.energy = CONFIG.START_E;
                this.maxEnergy = CONFIG.MAX_STORAGE;
                this.gold = CONFIG.START_G;
                this.units = [];
                this.selectedUnit = null;
                this.buildMode = null;
                this.moveMode = false;
                this.gatherMode = false;
                
                this.grid = [];
                for (let q = 0; q < CONFIG.MAP_W; q++) {
                    for (let r = 0; r < CONFIG.MAP_H; r++) {
                        const n = Math.sin(q * 0.3) * Math.cos(r * 0.3);
                        this.grid.push({
                            q, r, x: 0, y: 0,
                            height: Math.floor((n + 1) * 50),
                            energy: Math.random() < 0.2 ? Math.floor(Math.random() * 200) : 0,
                            gold: Math.random() < 0.1 ? Math.floor(Math.random() * 100) : 0,
                            building: null,
                            unit: null
                        });
                    }
                }
                
                const center = this.get(10, 10);
                if (center) {
                    center.building = { type: 'base', name: 'Âü∫Âú∞', storedE: 0 };
                    this.base = center;
                }
            }

            setup() {
                const resize = () => {
                    this.canvas.width = this.canvas.parentElement.clientWidth;
                    this.canvas.height = this.canvas.parentElement.clientHeight;
                };
                window.addEventListener('resize', resize);
                resize();

                let drag = false, last = { x: 0, y: 0 };
                this.canvas.addEventListener('mousedown', e => { drag = true; last = { x: e.clientX, y: e.clientY }; });
                this.canvas.addEventListener('mousemove', e => {
                    if (drag) {
                        this.camera.x += e.clientX - last.x;
                        this.camera.y += e.clientY - last.y;
                        last = { x: e.clientX, y: e.clientY };
                    }
                });
                this.canvas.addEventListener('mouseup', () => drag = false);
                this.canvas.addEventListener('wheel', e => {
                    e.preventDefault();
                    const f = e.deltaY > 0 ? 0.9 : 1.1;
                    this.camera.zoom = Math.max(0.3, Math.min(3, this.camera.zoom * f));
                });
                this.canvas.addEventListener('click', e => this.onClick(e));

                this.calcPositions();
            }

            calcPositions() {
                const h = Math.sqrt(3) * CONFIG.HEX_SIZE;
                for (const c of this.grid) {
                    c.x = CONFIG.HEX_SIZE * 1.5 * c.q;
                    c.y = h * (c.r + c.q * 0.5);
                }
            }

            get(q, r) { return this.grid.find(c => c.q === q && c.r === r); }

            toScreen(q, r) {
                const h = Math.sqrt(3) * CONFIG.HEX_SIZE;
                const x = CONFIG.HEX_SIZE * 1.5 * q;
                const y = h * (r + q * 0.5);
                return {
                    x: x * this.camera.zoom + this.camera.x + this.canvas.width / 2,
                    y: y * this.camera.zoom + this.camera.y + this.canvas.height / 2
                };
            }

            toHex(sx, sy) {
                const x = (sx - this.camera.x - this.canvas.width / 2) / this.camera.zoom;
                const y = (sy - this.camera.y - this.canvas.height / 2) / this.camera.zoom;
                const h = Math.sqrt(3) * CONFIG.HEX_SIZE;
                const q = Math.round((2/3) * x / CONFIG.HEX_SIZE);
                const r = Math.round((-1/3) * x / CONFIG.HEX_SIZE + y / h);
                return { q, r };
            }

            setBuild(type) {
                this.buildMode = type;
                this.moveMode = false;
                this.gatherMode = false;
                this.log('Âª∫ÈÄ†: ' + BUILDINGS[type]?.name);
            }

            cancelBuild() { this.buildMode = null; }
            toggleMove() { this.moveMode = !this.moveMode; this.gatherMode = false; this.buildMode = null; }
            toggleGather() { this.gatherMode = !this.gatherMode; this.moveMode = false; this.buildMode = null; }

            spawnUnit() {
                if (this.energy < 30 || this.units.length >= CONFIG.MAX_UNITS) {
                    this.log(this.units.length >= CONFIG.MAX_UNITS ? 'Âçï‰Ωç‰∏äÈôê' : 'ËÉΩÈáè‰∏çË∂≥');
                    return;
                }
                if (!this.base) return;
                
                this.energy -= 30;
                const u = {
                    id: Date.now() + Math.random(),
                    q: this.base.q, r: this.base.r,
                    hp: 100, maxHp: 100,
                    carrying: 0, carryType: null
                };
                this.units.push(u);
                this.get(u.q, u.r).unit = u;
                this.log('Âçï‰ΩçÂ∑≤ÁîüÊàê');
            }

            onClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const p = this.toHex(e.clientX - rect.left, e.clientY - rect.top);
                const cell = this.get(p.q, p.r);
                if (!cell) return;

                if (this.buildMode) {
                    const b = BUILDINGS[this.buildMode];
                    if (this.energy >= b.cost && !cell.building) {
                        this.energy -= b.cost;
                        cell.building = { type: this.buildMode, ...b, storedE: 0, storedG: 0 };
                        this.log('Âª∫ÈÄ†ÂÆåÊàê: ' + b.name);
                    }
                    this.buildMode = null;
                    return;
                }

                if (this.moveMode && this.selectedUnit) {
                    const u = this.selectedUnit;
                    const dist = (Math.abs(u.q - cell.q) + Math.abs(u.r - cell.r)) / 2;
                    if (dist <= 2 && !cell.unit) {
                        this.get(u.q, u.r).unit = null;
                        u.q = cell.q; u.r = cell.r;
                        cell.unit = u;
                        this.log('ÁßªÂä®ÂÆåÊàê');
                    }
                    this.moveMode = false;
                    return;
                }

                if (this.gatherMode && this.selectedUnit) {
                    const u = this.selectedUnit;
                    if (u.q === cell.q && u.r === cell.r) {
                        if (cell.energy > 0) {
                            const amt = Math.min(20, cell.energy);
                            cell.energy -= amt;
                            u.carrying += amt;
                            u.carryType = 'energy';
                            this.log('ÈááÈõÜ ' + amt + ' ËÉΩÈáè');
                        } else if (cell.gold > 0) {
                            const amt = Math.min(10, cell.gold);
                            cell.gold -= amt;
                            u.carrying += amt;
                            u.carryType = 'gold';
                            this.log('ÈááÈõÜ ' + amt + ' ÈªÑÈáë');
                        }
                    } else {
                        const dist = (Math.abs(u.q - cell.q) + Math.abs(u.r - cell.r)) / 2;
                        if (dist <= 1 && (cell.energy > 0 || cell.gold > 0)) {
                            this.get(u.q, u.r).unit = null;
                            u.q = cell.q; u.r = cell.r;
                            cell.unit = u;
                            this.log('ÁßªÂä®Âà∞ËµÑÊ∫êÁÇπ');
                        }
                    }
                    this.gatherMode = false;
                    return;
                }

                if (cell.unit) {
                    this.selectedUnit = cell.unit;
                }

                this.updateDetail(cell);
            }

            updateDetail(cell) {
                const d = document.getElementById('hexDetail');
                let html = `
                    <div class="stat-row"><span>ÂùêÊ†á</span><span>(${cell.q},${cell.r})</span></div>
                    <div class="stat-row"><span>È´òÂ∫¶</span><span>${cell.height}</span></div>
                    <div class="stat-row"><span>ËÉΩÈáèÁüø</span><span>${cell.energy}</span></div>
                    <div class="stat-row"><span>ÈªÑÈáëÁüø</span><span>${cell.gold}</span></div>
                `;
                if (cell.building) {
                    html += `<div class="stat-row"><span>Âª∫Á≠ë</span><span>${cell.building.name}</span></div>`;
                    if (cell.building.storedE > 0) {
                        html += `<div class="stat-row"><span>ÂÇ®Â≠òËÉΩÈáè</span><span>${cell.building.storedE}</span></div>`;
                    }
                }
                if (cell.unit) {
                    html += `<div class="stat-row"><span>Âçï‰Ωç</span><span>HP:${cell.unit.hp} Êê∫Â∏¶:${cell.unit.carrying}${cell.unit.carryType || ''}</span></div>`;
                }
                d.innerHTML = html;
            }

            update() {
                this.tick++;
                
                let prodE = 0;
                for (const c of this.grid) {
                    if (c.building?.prodE) {
                        const b = c.building;
                        b.storedE = Math.min(b.maxE || 999, b.storedE + b.prodE);
                        prodE += b.prodE;
                    }
                    if (c.building?.prodG) {
                        const b = c.building;
                        b.storedG = Math.min(b.maxG || 999, b.storedG + b.prodG);
                        this.gold += b.prodG;
                    }
                }

                for (const u of this.units) {
                    if (u.carrying > 0 && u.q === this.base?.q && u.r === this.base?.r) {
                        if (u.carryType === 'energy') {
                            this.energy = Math.min(this.maxEnergy, this.energy + u.carrying);
                        } else if (u.carryType === 'gold') {
                            this.gold += u.carrying;
                        }
                        u.carrying = 0;
                        u.carryType = null;
                        this.log('ËµÑÊ∫êÂ∑≤‰∫§‰ªò');
                    }
                }

                document.getElementById('resE').textContent = Math.floor(this.energy) + ' / ' + this.maxEnergy;
                document.getElementById('barE').style.width = (this.energy / this.maxEnergy * 100) + '%';
                document.getElementById('resG').textContent = this.gold;
                document.getElementById('resU').textContent = this.units.length + ' / ' + CONFIG.MAX_UNITS;
                document.getElementById('tickInfo').textContent = `Tick: ${this.tick} | Áîü‰∫ß: +${prodE}E/s`;

                const list = document.getElementById('unitList');
                if (this.units.length === 0) {
                    list.innerHTML = 'Êó†Âçï‰Ωç';
                } else {
                    list.innerHTML = this.units.map(u => {
                        const hpPct = u.hp / u.maxHp * 100;
                        return `<div class="unit-item ${u===this.selectedUnit?'selected':''}" onclick="game.selectedUnit=game.units.find(x=>x.id===${u.id});game.updateDetail(game.get(${u.q},${u.r}));">
                            <span>#${u.id.toString().slice(-4)} ${u.carrying>0?'üì¶':''}</span>
                            <div class="hp-bar"><div class="hp-fill" style="width:${hpPct}%"></div></div>
                        </div>`;
                    }).join('');
                }
            }

            draw() {
                this.ctx.fillStyle = '#0a0a15';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                for (const c of this.grid) {
                    const p = this.toScreen(c.q, c.r);
                    const s = CONFIG.HEX_SIZE * this.camera.zoom;
                    
                    if (p.x < -s || p.x > this.canvas.width + s || p.y < -s || p.y > this.canvas.height + s) continue;

                    this.ctx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const a = (Math.PI / 3) * i;
                        const x = p.x + s * Math.cos(a);
                        const y = p.y + s * Math.sin(a);
                        if (i === 0) this.ctx.moveTo(x, y);
                        else this.ctx.lineTo(x, y);
                    }
                    this.ctx.closePath();

                    const h = c.height;
                    this.ctx.fillStyle = `rgb(${30+h},${50+h/2},${30+h/3})`;
                    this.ctx.fill();

                    if (c.energy > 0) {
                        this.ctx.fillStyle = `rgba(255,215,0,${0.2 + c.energy/500})`;
                        this.ctx.fill();
                    }

                    if (c.building) {
                        const colors = { base: '#e94560', mineE: '#fd0', mineG: '#fa0', storageE: '#4a9', tower: '#f44' };
                        this.ctx.fillStyle = colors[c.building.type] || '#fff';
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, s * 0.5, 0, Math.PI * 2);
                        this.ctx.fill();
                    }

                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }

                for (const u of this.units) {
                    const p = this.toScreen(u.q, u.r);
                    const s = CONFIG.HEX_SIZE * this.camera.zoom * 0.4;
                    this.ctx.fillStyle = u === this.selectedUnit ? '#0f0' : '#4a9';
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, s, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    if (u.carrying > 0) {
                        this.ctx.fillStyle = '#fd0';
                        this.ctx.beginPath();
                        this.ctx.arc(p.x + s, p.y - s, s * 0.3, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            }

            start() {
                setInterval(() => { if (!this.paused) this.update(); }, CONFIG.TICK_RATE / this.speed);
                const loop = () => { this.draw(); requestAnimationFrame(loop); };
                loop();
            }

            log(msg) {
                const log = document.getElementById('log');
                const e = document.createElement('div');
                e.className = 'log-entry';
                e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                log.insertBefore(e, log.firstChild);
                if (log.children.length > 20) log.lastChild.remove();
            }

            save() {
                const data = {
                    tick: this.tick, energy: this.energy, gold: this.gold,
                    units: this.units,
                    grid: this.grid.map(c => ({
                        q: c.q, r: c.r, height: c.height,
                        energy: c.energy, gold: c.gold,
                        building: c.building
                    }))
                };
                localStorage.setItem('clawcraft_save', JSON.stringify(data));
                this.log('Ê∏∏ÊàèÂ∑≤‰øùÂ≠ò');
            }

            load() {
                const data = localStorage.getItem('clawcraft_save');
                if (!data) { this.log('Ê≤°ÊúâÂ≠òÊ°£'); return; }
                const d = JSON.parse(data);
                this.tick = d.tick || 0;
                this.energy = d.energy || 0;
                this.gold = d.gold || 0;
                this.units = d.units || [];
                for (const c of d.grid || []) {
                    const cell = this.get(c.q, c.r);
                    if (cell) {
                        cell.height = c.height;
                        cell.energy = c.energy;
                        cell.gold = c.gold;
                        cell.building = c.building;
                    }
                }
                this.base = this.grid.find(c => c.building?.type === 'base');
                this.log('Ê∏∏ÊàèÂ∑≤Âä†ËΩΩ');
            }

            reset() {
                if (confirm('Á°ÆÂÆöÈáçÁΩÆÊ∏∏ÊàèÔºü')) {
                    this.resetData();
                    this.log('Ê∏∏ÊàèÂ∑≤ÈáçÁΩÆ');
                }
            }
        }

        const game = new Game();
    </script>
</body>
</html>
