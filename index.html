<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawCraft - Full Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a15;
            color: #fff;
            overflow: hidden;
            font-size: 13px;
        }
        #gameContainer {
            display: flex;
            height: 100vh;
        }
        #canvasContainer {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #gameCanvas { cursor: grab; }
        #gameCanvas:active { cursor: grabbing; }
        #sidebar {
            width: 350px;
            background: #1a1a2e;
            border-left: 2px solid #e94560;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        h1 { color: #e94560; font-size: 1.5em; margin-bottom: 10px; }
        h2 { color: #e94560; font-size: 1.1em; margin-bottom: 8px; }
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 12px;
        }
        .stat-label { color: #888; }
        .stat-value { color: #fff; font-weight: bold; }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #e94560;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 3px;
        }
        button:hover { background: #ff6b6b; }
        button:disabled { background: #444; cursor: not-allowed; }
        button.active { background: #4a9; }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .build-btn {
            background: #2a4a6a;
            font-size: 11px;
            padding: 6px 8px;
        }
        .build-btn:hover { background: #3a5a8a; }
        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .layer-toggle:hover { background: rgba(233, 69, 96, 0.2); }
        #tooltip {
            position: absolute;
            background: rgba(0,0,0,0.95);
            border: 1px solid #e94560;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            display: none;
            z-index: 1000;
            font-size: 11px;
            max-width: 250px;
        }
        .unit-list {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            padding: 5px;
        }
        .unit-item {
            padding: 5px;
            margin: 3px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .unit-item:hover { background: rgba(233, 69, 96, 0.3); }
        .unit-item.selected { background: #e94560; }
        .log {
            max-height: 100px;
            overflow-y: auto;
            background: #0f0f23;
            border-radius: 5px;
            padding: 8px;
            font-family: monospace;
            font-size: 10px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #1a1a3e;
        }
        .module-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        .module-btn {
            font-size: 10px;
            padding: 5px;
            background: #3a3a5a;
        }
        .module-btn.selected { background: #4a9; }
        .cost { color: #fd0; font-size: 10px; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer">
            <canvas id="gameCanvas"></canvas>
            <div id="tooltip"></div>
        </div>
        <div id="sidebar">
            <h1>ü¶û ClawCraft Demo</h1>
            
            <div class="section">
                <h2>ËµÑÊ∫ê</h2>
                <div class="stat"><span class="stat-label">ËÉΩÈáè</span><span class="stat-value" id="resEnergy">500</span></div>
                <div class="stat"><span class="stat-label">ÈªÑÈáë</span><span class="stat-value" id="resGold">200</span></div>
                <div class="stat"><span class="stat-label">Âçï‰ΩçÊï∞</span><span class="stat-value" id="unitCount">0</span></div>
            </div>

            <div class="section">
                <h2>ÈÄâ‰∏≠Ê†ºÂ≠ê</h2>
                <div id="hexInfo">ÁÇπÂáªÂú∞ÂõæÊü•Áúã</div>
            </div>

            <div class="section">
                <h2>Âª∫ÈÄ†</h2>
                <div class="btn-group">
                    <button class="build-btn" onclick="game.setBuildMode('command')">ÊåáÊå•‰∏≠ÂøÉ 100E</button>
                    <button class="build-btn" onclick="game.setBuildMode('signal')">‰ø°Âè∑Â°î 50E</button>
                    <button class="build-btn" onclick="game.setBuildMode('mine')">Âú∞Èõ∑ 20E</button>
                </div>
                <button onclick="game.cancelBuild()">ÂèñÊ∂àÂª∫ÈÄ†</button>
            </div>

            <div class="section">
                <h2>Âçï‰ΩçÊéßÂà∂</h2>
                <div class="unit-list" id="unitList">Êó†Âçï‰Ωç</div>
                <div class="btn-group" style="margin-top:10px;">
                    <button onclick="game.spawnUnit()">ÁîüÊàêÂçï‰Ωç 50E</button>
                    <button onclick="game.toggleMove()">ÁßªÂä®Ê®°Âºè</button>
                </div>
            </div>

            <div class="section">
                <h2>Êìç‰Ωú</h2>
                <div class="btn-group">
                    <button onclick="game.regenerate()">Êñ∞Âú∞Âõæ</button>
                    <button onclick="game.export()">ÂØºÂá∫</button>
                </div>
            </div>

            <div class="section">
                <h2>Êó•Âøó</h2>
                <div class="log" id="gameLog"></div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            MAP_WIDTH: 20,
            MAP_HEIGHT: 20,
            HEX_SIZE: 30,
            MAX_HEIGHT: 100,
            SIGNAL_RANGE: 5,
            START_ENERGY: 500,
            START_GOLD: 200
        };

        function noise(x, y) {
            const sin = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;
            return sin - Math.floor(sin);
        }

        function distance(a, b) {
            return (Math.abs(a.q - b.q) + Math.abs(a.q + a.r - b.q - b.r) + Math.abs(a.r - b.r)) / 2;
        }

        class HexGrid {
            constructor(w, h) {
                this.width = w;
                this.height = h;
                this.cells = [];
                this.generate();
            }

            generate() {
                this.cells = [];
                for (let q = 0; q < this.width; q++) {
                    for (let r = 0; r < this.height; r++) {
                        const h = Math.floor(noise(q * 0.1, r * 0.1) * CONFIG.MAX_HEIGHT);
                        this.cells.push({
                            q, r, x: 0, y: 0,
                            height: Math.max(0, h),
                            hardness: Math.floor(20 + (h / CONFIG.MAX_HEIGHT) * 60),
                            energy: Math.random() < 0.15 ? Math.floor(Math.random() * 300) + 50 : 0,
                            gold: Math.random() < 0.08 ? Math.floor(Math.random() * 100) + 20 : 0,
                            building: null,
                            visible: false,
                            explored: false
                        });
                    }
                }
            }

            get(q, r) { return this.cells.find(c => c.q === q && c.r === r); }
        }

        class Game {
            constructor() {
                this.grid = new HexGrid(CONFIG.MAP_WIDTH, CONFIG.MAP_HEIGHT);
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.camera = { x: 0, y: 0, zoom: 1 };
                this.energy = CONFIG.START_ENERGY;
                this.gold = CONFIG.START_GOLD;
                this.units = [];
                this.selectedUnit = null;
                this.buildMode = null;
                this.moveMode = false;
                this.commands = [];
                
                this.setupCanvas();
                this.setupEvents();
                this.calculatePositions();
                this.initPlayer();
                this.startLoop();
                this.log('Ê∏∏ÊàèÂºÄÂßãÔºÅÁÇπÂáªÂú∞ÂõæÂª∫ÈÄ†');
            }

            setupCanvas() {
                const resize = () => {
                    this.canvas.width = this.canvas.parentElement.clientWidth;
                    this.canvas.height = this.canvas.parentElement.clientHeight;
                    this.render();
                };
                window.addEventListener('resize', resize);
                resize();
            }

            setupEvents() {
                let dragging = false, lastPos = { x: 0, y: 0 };
                
                this.canvas.addEventListener('mousedown', e => {
                    dragging = true;
                    lastPos = { x: e.clientX, y: e.clientY };
                });

                this.canvas.addEventListener('mousemove', e => {
                    if (dragging) {
                        this.camera.x += e.clientX - lastPos.x;
                        this.camera.y += e.clientY - lastPos.y;
                        lastPos = { x: e.clientX, y: e.clientY };
                        this.render();
                    }
                });

                this.canvas.addEventListener('mouseup', () => dragging = false);
                
                this.canvas.addEventListener('click', e => {
                    if (!dragging) this.handleClick(e);
                });

                this.canvas.addEventListener('wheel', e => {
                    e.preventDefault();
                    const factor = e.deltaY > 0 ? 0.9 : 1.1;
                    this.camera.zoom = Math.max(0.3, Math.min(3, this.camera.zoom * factor));
                    this.render();
                });
            }

            calculatePositions() {
                const hexH = Math.sqrt(3) * CONFIG.HEX_SIZE;
                for (const c of this.grid.cells) {
                    c.x = CONFIG.HEX_SIZE * 1.5 * c.q;
                    c.y = hexH * (c.r + c.q * 0.5);
                }
            }

            initPlayer() {
                const center = this.grid.get(10, 10);
                if (center) {
                    center.building = 'command';
                    this.commands.push(center);
                    this.updateVisibility();
                }
            }

            hexToScreen(q, r) {
                const hexH = Math.sqrt(3) * CONFIG.HEX_SIZE;
                const x = CONFIG.HEX_SIZE * 1.5 * q;
                const y = hexH * (r + q * 0.5);
                return {
                    x: x * this.camera.zoom + this.camera.x + this.canvas.width / 2,
                    y: y * this.camera.zoom + this.camera.y + this.canvas.height / 2
                };
            }

            screenToHex(sx, sy) {
                const x = (sx - this.camera.x - this.canvas.width / 2) / this.camera.zoom;
                const y = (sy - this.camera.y - this.canvas.height / 2) / this.camera.zoom;
                const hexH = Math.sqrt(3) * CONFIG.HEX_SIZE;
                const q = Math.round((2/3) * x / CONFIG.HEX_SIZE);
                const r = Math.round((-1/3) * x / CONFIG.HEX_SIZE + y / hexH);
                return { q, r };
            }

            setBuildMode(type) {
                this.buildMode = type;
                this.log('Âª∫ÈÄ†Ê®°Âºè: ' + type);
            }

            cancelBuild() {
                this.buildMode = null;
            }

            spawnUnit() {
                if (this.energy < 50) {
                    this.log('ËÉΩÈáè‰∏çË∂≥');
                    return;
                }
                const spawn = this.commands[0];
                if (!spawn) return;
                
                this.energy -= 50;
                this.units.push({
                    id: Date.now(),
                    q: spawn.q,
                    r: spawn.r,
                    hp: 100
                });
                this.updateUI();
                this.log('Âçï‰ΩçÂ∑≤ÁîüÊàê');
            }

            toggleMove() {
                this.moveMode = !this.moveMode;
                this.log(this.moveMode ? 'ÁßªÂä®Ê®°ÂºèÂºÄÂêØ' : 'ÁßªÂä®Ê®°ÂºèÂÖ≥Èó≠');
            }

            handleClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const pos = this.screenToHex(e.clientX - rect.left, e.clientY - rect.top);
                const hex = this.grid.get(pos.q, pos.r);
                if (!hex) return;

                if (this.buildMode) {
                    const costs = { command: 100, signal: 50, mine: 20 };
                    const cost = costs[this.buildMode] || 50;
                    if (this.energy >= cost && !hex.building) {
                        this.energy -= cost;
                        hex.building = this.buildMode;
                        if (this.buildMode === 'command') this.commands.push(hex);
                        this.updateVisibility();
                        this.updateUI();
                        this.log('Âª∫ÈÄ†ÂÆåÊàê: ' + this.buildMode);
                    }
                    this.buildMode = null;
                    return;
                }

                if (this.moveMode && this.selectedUnit) {
                    const dist = distance(this.selectedUnit, hex);
                    if (dist <= 2) {
                        this.selectedUnit.q = hex.q;
                        this.selectedUnit.r = hex.r;
                        this.updateVisibility();
                        this.log('Âçï‰ΩçÁßªÂä®ÂÆåÊàê');
                    }
                    this.moveMode = false;
                    return;
                }

                const unit = this.units.find(u => u.q === hex.q && u.r === hex.r);
                if (unit) {
                    this.selectedUnit = unit;
                    this.log('ÈÄâ‰∏≠Âçï‰Ωç');
                }

                this.updateHexInfo(hex);
                this.render();
            }

            updateHexInfo(hex) {
                const info = document.getElementById('hexInfo');
                info.innerHTML = `
                    <div class="stat"><span class="stat-label">ÂùêÊ†á</span><span class="stat-value">(${hex.q}, ${hex.r})</span></div>
                    <div class="stat"><span class="stat-label">È´òÂ∫¶</span><span class="stat-value">${hex.height}</span></div>
                    <div class="stat"><span class="stat-label">Á°¨Â∫¶</span><span class="stat-value">${hex.hardness}</span></div>
                    <div class="stat"><span class="stat-label">ËÉΩÈáè</span><span class="stat-value">${hex.energy || 'Êó†'}</span></div>
                    <div class="stat"><span class="stat-label">ÈªÑÈáë</span><span class="stat-value">${hex.gold || 'Êó†'}</span></div>
                    ${hex.building ? `<div class="stat"><span class="stat-label">Âª∫Á≠ë</span><span class="stat-value">${hex.building}</span></div>` : ''}
                `;
            }

            updateVisibility() {
                for (const c of this.grid.cells) c.visible = false;
                
                for (const cmd of this.commands) {
                    for (const c of this.grid.cells) {
                        if (distance(cmd, c) <= CONFIG.SIGNAL_RANGE) {
                            c.visible = true;
                            c.explored = true;
                        }
                    }
                }
                
                for (const u of this.units) {
                    for (const c of this.grid.cells) {
                        if (distance(u, c) <= 3) {
                            c.visible = true;
                            c.explored = true;
                        }
                    }
                }
            }

            updateUI() {
                document.getElementById('resEnergy').textContent = this.energy;
                document.getElementById('resGold').textContent = this.gold;
                document.getElementById('unitCount').textContent = this.units.length;
                
                const list = document.getElementById('unitList');
                if (this.units.length === 0) {
                    list.innerHTML = 'Êó†Âçï‰Ωç';
                } else {
                    list.innerHTML = this.units.map(u => 
                        `<div class="unit-item ${u === this.selectedUnit ? 'selected' : ''}" onclick="game.selectedUnit = game.units.find(x=>x.id===${u.id}); game.updateUI();">
                            Âçï‰Ωç #${u.id.toString().slice(-4)} HP:${u.hp}
                        </div>`
                    ).join('');
                }
            }

            log(msg) {
                const logEl = document.getElementById('gameLog');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                logEl.insertBefore(entry, logEl.firstChild);
            }

            getHeightColor(h) {
                const r = Math.floor(26 + (h / CONFIG.MAX_HEIGHT) * 100);
                const g = Math.floor(58 + (h / CONFIG.MAX_HEIGHT) * 40);
                const b = Math.floor(26 + (h / CONFIG.MAX_HEIGHT) * 60);
                return `rgb(${r},${g},${b})`;
            }

            drawHex(c) {
                const pos = this.hexToScreen(c.q, c.r);
                const size = CONFIG.HEX_SIZE * this.camera.zoom;
                
                if (pos.x < -size || pos.x > this.canvas.width + size ||
                    pos.y < -size || pos.y > this.canvas.height + size) return;

                this.ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = (Math.PI / 3) * i;
                    const x = pos.x + size * Math.cos(angle);
                    const y = pos.y + size * Math.sin(angle);
                    if (i === 0) this.ctx.moveTo(x, y);
                    else this.ctx.lineTo(x, y);
                }
                this.ctx.closePath();

                if (!c.explored) {
                    this.ctx.fillStyle = '#050510';
                } else if (!c.visible) {
                    this.ctx.fillStyle = '#1a1a2e';
                } else {
                    this.ctx.fillStyle = this.getHeightColor(c.height);
                }
                this.ctx.fill();

                if (c.visible) {
                    if (c.energy > 0) {
                        this.ctx.fillStyle = 'rgba(255,215,0,0.3)';
                        this.ctx.fill();
                    }
                    if (c.building) {
                        const colors = { command: '#e94560', signal: '#4a9', mine: '#888' };
                        this.ctx.fillStyle = colors[c.building] || '#fff';
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, size * 0.4, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }

                this.ctx.strokeStyle = c.visible ? '#444' : '#1a1a2e';
                this.ctx.lineWidth = 1;
                this.ctx.stroke();
            }

            render() {
                this.ctx.fillStyle = '#0a0a15';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (const c of this.grid.cells) {
                    this.drawHex(c);
                }

                for (const u of this.units) {
                    const pos = this.hexToScreen(u.q, u.r);
                    const size = CONFIG.HEX_SIZE * this.camera.zoom * 0.5;
                    this.ctx.fillStyle = u === this.selectedUnit ? '#0f0' : '#4a9';
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            startLoop() {
                const loop = () => {
                    this.render();
                    requestAnimationFrame(loop);
                };
                loop();
            }

            regenerate() {
                this.grid.generate();
                this.calculatePositions();
                this.commands = [];
                this.units = [];
                this.energy = CONFIG.START_ENERGY;
                this.gold = CONFIG.START_GOLD;
                this.initPlayer();
                this.updateUI();
                this.log('Êñ∞Âú∞ÂõæÂ∑≤ÁîüÊàê');
            }

            export() {
                const data = {
                    energy: this.energy,
                    gold: this.gold,
                    units: this.units,
                    cells: this.grid.cells.map(c => ({
                        q: c.q, r: c.r, building: c.building,
                        height: c.height, energy: c.energy, gold: c.gold
                    }))
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'clawcraft-save.json';
                a.click();
            }
        }

        const game = new Game();
    </script>
</body>
</html>
