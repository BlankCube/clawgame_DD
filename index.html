<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal War - v6 Universal Matter</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #050508; color: #fff; overflow: hidden; font-size: 11px; }
        #gameContainer { display: flex; height: 100vh; }
        #canvasContainer { flex: 1; position: relative; overflow: hidden; }
        #signalCanvas, #worldCanvas { position: absolute; top: 0; left: 0; }
        #worldCanvas { cursor: grab; }
        #worldCanvas:active { cursor: grabbing; }
        #sidebar { width: 360px; background: #0a0a12; border-left: 2px solid #4a9; padding: 10px; overflow-y: auto; }
        h1 { color: #4a9; font-size: 1.1em; margin-bottom: 5px; }
        h2 { color: #4a9; font-size: 0.9em; margin: 10px 0 5px; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .section { background: rgba(255,255,255,0.03); border-radius: 4px; padding: 8px; margin-bottom: 8px; border: 1px solid #222; }
        .stat-row { display: flex; justify-content: space-between; padding: 3px 6px; background: rgba(0,0,0,0.3); border-radius: 2px; margin: 2px 0; font-size: 10px; }
        .resource-E { color: #fd0; }
        .resource-M { color: #aaa; }
        .resource-I { color: #0af; }
        .signal-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
        .signal-high { background: #f44; box-shadow: 0 0 6px #f44; }
        .signal-med { background: #fa0; box-shadow: 0 0 4px #fa0; }
        .signal-low { background: #4a9; box-shadow: 0 0 2px #4a9; }
        button { padding: 4px 8px; border: none; border-radius: 3px; background: #2a4a3a; color: #fff; font-size: 10px; cursor: pointer; margin: 2px; border: 1px solid #3a5a4a; }
        button:hover { background: #3a5a4a; }
        button:disabled { background: #222; color: #555; border-color: #333; }
        button.active { background: #4a9; border-color: #5aba5a; }
        .mode-btn { background: #2a3a5a; border-color: #3a4a6a; }
        .mode-btn:hover { background: #3a4a6a; }
        .danger-btn { background: #4a2a2a; border-color: #6a3a3a; }
        .danger-btn:hover { background: #6a3a3a; }
        .log { max-height: 100px; overflow-y: auto; background: #000; padding: 5px; font-family: monospace; font-size: 9px; border: 1px solid #222; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #111; }
        .log-entry.signal { color: #fa0; }
        .log-entry.combat { color: #f44; }
        .log-entry.info { color: #4a9; }
        .matter-bar { height: 4px; background: #222; margin-top: 2px; border-radius: 2px; overflow: hidden; }
        .matter-fill { height: 100%; transition: width 0.3s; }
        .layer-control { display: flex; gap: 5px; margin: 5px 0; }
        .layer-btn { flex: 1; padding: 3px; font-size: 9px; background: #1a1a1a; border: 1px solid #333; }
        .layer-btn.active { background: #2a4a3a; border-color: #4a9; }
        #minimap { width: 100%; height: 80px; background: #000; border: 1px solid #333; margin: 5px 0; }
        .concept-box { background: rgba(74,170,153,0.1); border-left: 3px solid #4a9; padding: 8px; margin: 5px 0; font-size: 10px; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer">
            <canvas id="signalCanvas"></canvas>
            <canvas id="worldCanvas"></canvas>
        </div>
        <div id="sidebar">
            <h1>ğŸ“¡ Signal War v6</h1>
            
            <div class="concept-box">
                <strong>æ ¸å¿ƒæ¦‚å¿µ</strong>: ä¿¡å·=æƒ…æŠ¥ï¼Œå¯è¢«ä¼ªé€ ã€‚ç”Ÿäº§äº§ç”Ÿä¿¡å·ï¼Œæš´éœ²ä½ç½®ã€‚åå‹¤è¿è¾“äº§ç”Ÿä¿¡å·ï¼Œå¯è¢«æ‹¦æˆªã€‚
            </div>

            <div class="section">
                <h2>åŸºç¡€å…ƒç´ </h2>
                <div class="stat-row">
                    <span class="resource-E">âš¡ èƒ½é‡ (E)</span>
                    <span id="resE">0</span>
                </div>
                <div class="matter-bar"><div class="matter-fill" id="barE" style="width:0%; background:#fd0;"></div></div>
                
                <div class="stat-row" style="margin-top:6px;">
                    <span class="resource-M">ğŸ”© ç‰©è´¨ (M)</span>
                    <span id="resM">0</span>
                </div>
                <div class="matter-bar"><div class="matter-fill" id="barM" style="width:0%; background:#aaa;"></div></div>
                
                <div class="stat-row" style="margin-top:6px;">
                    <span class="resource-I">ğŸ“¡ ä¿¡æ¯ (I)</span>
                    <span id="resI">0</span>
                </div>
                <div class="matter-bar"><div class="matter-fill" id="barI" style="width:0%; background:#0af;"></div></div>
            </div>

            <div class="section">
                <h2>ä¿¡å·å±‚</h2>
                <div class="layer-control">
                    <button class="layer-btn active" id="layer-world" onclick="game.setLayer('world')">ä¸–ç•Œ</button>
                    <button class="layer-btn" id="layer-signal" onclick="game.setLayer('signal')">ä¿¡å·</button>
                    <button class="layer-btn" id="layer-heatmap" onclick="game.setLayer('heatmap')">çƒ­å›¾</button>
                </div>
                <div id="signalLegend">
                    <div class="stat-row"><span class="signal-indicator signal-high"></span>é«˜å¼ºåº¦ä¿¡å·</div>
                    <div class="stat-row"><span class="signal-indicator signal-med"></span>ä¸­å¼ºåº¦ä¿¡å·</div>
                    <div class="stat-row"><span class="signal-indicator signal-low"></span>ä½å¼ºåº¦ä¿¡å·</div>
                </div>
            </div>

            <div class="section">
                <h2>æ“ä½œæ¨¡å¼</h2>
                <div style="display:flex; flex-wrap:wrap; gap:3px;">
                    <button class="mode-btn" id="mode-select" onclick="game.setMode('select')">é€‰æ‹©</button>
                    <button class="mode-btn" id="mode-build" onclick="game.setMode('build')">å»ºé€ </button>
                    <button class="mode-btn" id="mode-destroy" onclick="game.setMode('destroy')">ç ´å</button>
                    <button class="mode-btn" id="mode-transport" onclick="game.setMode('transport')">è¿è¾“</button>
                    <button class="mode-btn" id="mode-forge" onclick="game.setMode('forge')">ä¼ªé€ ä¿¡å·</button>
                    <button class="mode-btn" id="mode-scout" onclick="game.setMode('scout')">ä¾¦å¯Ÿ</button>
                </div>
                <div id="modeDetail" style="margin-top:8px; font-size:10px; color:#888;">é€‰æ‹©æ¨¡å¼æŸ¥çœ‹è¯¦æƒ…</div>
            </div>

            <div class="section">
                <h2>é€‰ä¸­ç›®æ ‡</h2>
                <div id="targetInfo">ç‚¹å‡»åœ°å›¾é€‰æ‹©ç›®æ ‡</div>
            </div>

            <div class="section">
                <h2>ç‰©æµç®¡ç†</h2>
                <div id="logisticsInfo">
                    <div class="stat-row"><span>æ´»è·ƒè¿è¾“é˜Ÿ</span><span id="transportCount">0</span></div>
                    <div class="stat-row"><span>æ€»åº“å­˜ä»·å€¼</span><span id="inventoryValue">0</span></div>
                    <div class="stat-row"><span>ä¿¡å·æš´éœ²åº¦</span><span id="exposureLevel">ä½</span></div>
                </div>
            </div>

            <div class="section">
                <div style="display:flex; flex-wrap:wrap; gap:3px;">
                    <button onclick="game.speed = game.speed==1?10:1">â© x10</button>
                    <button onclick="game.pause = !game.pause">â¸ï¸ æš‚åœ</button>
                    <button onclick="game.save()">ğŸ’¾ ä¿å­˜</button>
                    <button class="danger-btn" onclick="game.reset()">ğŸ”„ é‡ç½®</button>
                </div>
            </div>

            <div class="section">
                <h2>ä¿¡å·æ—¥å¿—</h2>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Signal War v6 - Universal Matter System
        // ==========================================
        // æ ¸å¿ƒè®¾è®¡ï¼š
        // 1. ä¸‰ç§åŸºç¡€å…ƒç´ æ„æˆä¸€åˆ‡
        // 2. ä¿¡å·=æƒ…æŠ¥ï¼Œç”Ÿäº§/ç§»åŠ¨/æˆ˜æ–—éƒ½äº§ç”Ÿä¿¡å·
        // 3. ä¿¡æ¯(I)å¯ç”¨äºä¼ªé€ ä¿¡å·
        // 4. ç‰©æµè¿è¾“äº§ç”Ÿå¯è¢«æ‹¦æˆªçš„ä¿¡å·
        // 5. æ‰€æœ‰ç‰©è´¨éƒ½å¯ç ´åå’Œå»ºé€ 

        const CONFIG = {
            MAP_W: 100, MAP_H: 100,          // è¶…å¤§åœ°å›¾
            HEX_SIZE: 16,                     // å°æ ¼å­ï¼Œå¤§åœ°å›¾
            TICK_RATE: 200,                   // å¿«é€Ÿtick
            CHUNK_SIZE: 10,                   // åŒºåŸŸåˆ’åˆ†
            
            // åŸºç¡€å…ƒç´ 
            START_E: 1000,    // èƒ½é‡
            START_M: 500,     // ç‰©è´¨
            START_I: 100,     // ä¿¡æ¯
            
            // ä¿¡å·è¡°å‡
            SIGNAL_DECAY: 0.95,
            SIGNAL_THRESHOLD: 0.1,
            
            // ç”Ÿäº§æˆæœ¬
            BUILD_COST_M: 50,
            BUILD_COST_E: 20,
            PRODUCE_SIGNAL: 5,  // ç”Ÿäº§äº§ç”Ÿçš„ä¿¡å·å¼ºåº¦
            
            // è¿è¾“
            TRANSPORT_SPEED: 2,
            TRANSPORT_CAPACITY: 100,
            TRANSPORT_SIGNAL: 2,  // è¿è¾“äº§ç”Ÿçš„ä¿¡å·
            
            // ä¼ªé€ 
            FORGE_COST_I: 50,
            FORGE_DURATION: 100,
            
            // ä¾¦å¯Ÿ
            SCOUT_RANGE: 10,
            SCOUT_PRECISION: 0.8  // ä¾¦å¯Ÿç²¾åº¦ï¼ˆæ— æ³•100%ç¡®å®šçœŸå‡ï¼‰
        };

        // ç‰©è´¨ç±»å‹ - æ‰€æœ‰ä¸œè¥¿éƒ½ç”±è¿™ä¸‰ç§æ„æˆ
        const MATTER = {
            E: { name: 'èƒ½é‡', color: '#fd0', signal: 1 },
            M: { name: 'ç‰©è´¨', color: '#aaa', signal: 0.3 },
            I: { name: 'ä¿¡æ¯', color: '#0af', signal: 0 }
        };

        // å®ä½“ç±»å‹ - ç”± E+M+I ç»„æˆ
        const ENTITIES = {
            // åœ°å½¢
            terrain: { 
                composition: { M: 100 }, 
                destructible: true,
                signal: 0
            },
            
            // ç”Ÿäº§å»ºç­‘ - äº§ç”ŸEï¼Œä½†äº§ç”Ÿå¼ºä¿¡å·
            generator: { 
                composition: { M: 200, E: 50 },
                output: { E: 5 },
                signal: 10,
                destructible: true
            },
            
            // ç²¾ç‚¼å‚ - å°†Mè½¬åŒ–ä¸ºE
            refinery: {
                composition: { M: 300, E: 100 },
                convert: { M: -10, E: 8 },
                signal: 8,
                destructible: true
            },
            
            // ä¿¡æ¯ç«™ - äº§ç”ŸIï¼Œä½ä¿¡å·
            infoStation: {
                composition: { M: 150, E: 100, I: 20 },
                output: { I: 2 },
                signal: 3,
                destructible: true
            },
            
            // ä»“åº“ - å­˜å‚¨èµ„æº
            storage: {
                composition: { M: 400 },
                capacity: 1000,
                signal: 2,
                destructible: true
            },
            
            // è¿è¾“å•ä½ - ç§»åŠ¨æ—¶äº§ç”Ÿä¿¡å·
            transport: {
                composition: { M: 50, E: 30 },
                speed: CONFIG.TRANSPORT_SPEED,
                capacity: CONFIG.TRANSPORT_CAPACITY,
                moveSignal: CONFIG.TRANSPORT_SIGNAL,
                destructible: true
            },
            
            // æˆ˜æ–—å•ä½
            combat: {
                composition: { M: 100, E: 50, I: 10 },
                atk: 20,
                def: 10,
                hp: 100,
                moveSignal: 5,
                attackSignal: 20,
                destructible: true
            },
            
            // ä¿¡å·ä¼ªé€ å™¨ - äº§ç”Ÿå‡ä¿¡å·
            forger: {
                composition: { M: 200, E: 100, I: 100 },
                forgeCost: { I: CONFIG.FORGE_COST_I },
                signal: 1,
                destructible: true
            },
            
            // ä¾¦å¯Ÿå•ä½ - ä½ä¿¡å·ï¼Œå¯è¯†åˆ«ä¼ªé€ 
            scout: {
                composition: { M: 30, E: 20, I: 30 },
                detectRange: CONFIG.SCOUT_RANGE,
                detectPrecision: CONFIG.SCOUT_PRECISION,
                moveSignal: 1,
                destructible: true
            }
        };

        class SignalWar {
            constructor() {
                this.worldCanvas = document.getElementById('worldCanvas');
                this.signalCanvas = document.getElementById('signalCanvas');
                this.wCtx = this.worldCanvas.getContext('2d');
                this.sCtx = this.signalCanvas.getContext('2d');
                
                this.camera = { x: 0, y: 0, zoom: 1 };
                this.tick = 0;
                this.speed = 1;
                this.pause = false;
                
                // èµ„æº
                this.resources = { E: CONFIG.START_E, M: CONFIG.START_M, I: CONFIG.START_I };
                this.maxStorage = 5000;
                
                // åœ°å›¾æ•°æ®
                this.grid = [];
                this.signals = [];  // ä¿¡å·å±‚
                this.entities = []; // æ‰€æœ‰å®ä½“
                this.transports = []; // è¿è¾“é˜Ÿ
                
                // ç©å®¶çŠ¶æ€
                this.mode = 'select';
                this.selected = null;
                this.layer = 'world';
                
                this.init();
                this.setup();
                this.start();
            }

            init() {
                // åˆå§‹åŒ–åœ°å›¾ - çº¯ç‰©è´¨åœ°å½¢
                for(let q = 0; q < CONFIG.MAP_W; q++) {
                    for(let r = 0; r < CONFIG.MAP_H; r++) {
                        // ä½¿ç”¨å™ªå£°ç”Ÿæˆåœ°å½¢é«˜åº¦
                        const noise = this.noise(q * 0.05, r * 0.05);
                        const height = Math.floor((noise + 1) * 50);
                        
                        this.grid.push({
                            q, r,
                            x: 0, y: 0,  // å±å¹•åæ ‡ï¼Œç¨åè®¡ç®—
                            height,
                            matter: height * 10,  // åœ°å½¢å«æœ‰çš„ç‰©è´¨é‡
                            entity: null,  // è¯¥ä½ç½®çš„å®ä½“
                            owner: null    // æ‰€æœ‰è€…
                        });
                        
                        // åˆå§‹åŒ–ä¿¡å·å±‚
                        this.signals.push({
                            q, r,
                            strength: 0,   // ä¿¡å·å¼ºåº¦
                            source: null,  // ä¿¡å·æº
                            isFake: false, // æ˜¯å¦ä¼ªé€ 
                            age: 0         // ä¿¡å·å¹´é¾„
                        });
                    }
                }
                
                // ç©å®¶èµ·å§‹ä½ç½® - ä¸­å¿ƒåŒºåŸŸ
                const centerQ = Math.floor(CONFIG.MAP_W / 2);
                const centerR = Math.floor(CONFIG.MAP_H / 2);
                
                // åˆ›å»ºèµ·å§‹åŸºåœ°
                this.createEntity(centerQ, centerR, 'generator', 'player');
                this.createEntity(centerQ + 1, centerR, 'storage', 'player');
                this.createEntity(centerQ, centerR + 1, 'refinery', 'player');
                
                this.calcPositions();
            }

            noise(x, y) {
                return Math.sin(x * 12.9898 + y * 78.233) * 43758.5453 % 1;
            }

            calcPositions() {
                const h = Math.sqrt(3) * CONFIG.HEX_SIZE;
                for(const cell of this.grid) {
                    cell.x = CONFIG.HEX_SIZE * 1.5 * cell.q;
                    cell.y = h * (cell.r + cell.q * 0.5);
                }
            }

            setup() {
                const resize = () => {
                    const container = this.worldCanvas.parentElement;
                    this.worldCanvas.width = container.clientWidth;
                    this.worldCanvas.height = container.clientHeight;
                    this.signalCanvas.width = container.clientWidth;
                    this.signalCanvas.height = container.clientHeight;
                };
                window.addEventListener('resize', resize);
                resize();
                
                // é¼ æ ‡æ§åˆ¶
                let dragging = false;
                let lastPos = { x: 0, y: 0 };
                
                this.worldCanvas.addEventListener('mousedown', e => {
                    dragging = true;
                    lastPos = { x: e.clientX, y: e.clientY };
                });
                
                this.worldCanvas.addEventListener('mousemove', e => {
                    if(dragging) {
                        this.camera.x += e.clientX - lastPos.x;
                        this.camera.y += e.clientY - lastPos.y;
                        lastPos = { x: e.clientX, y: e.clientY };
                    }
                });
                
                this.worldCanvas.addEventListener('mouseup', () => dragging = false);
                
                this.worldCanvas.addEventListener('wheel', e => {
                    e.preventDefault();
                    const factor = e.deltaY > 0 ? 0.9 : 1.1;
                    this.camera.zoom = Math.max(0.2, Math.min(5, this.camera.zoom * factor));
                });
                
                this.worldCanvas.addEventListener('click', e => this.onClick(e));
            }

            get(q, r) {
                if(q < 0 || q >= CONFIG.MAP_W || r < 0 || r >= CONFIG.MAP_H) return null;
                return this.grid[r * CONFIG.MAP_W + q];
            }

            getSignal(q, r) {
                if(q < 0 || q >= CONFIG.MAP_W || r < 0 || r >= CONFIG.MAP_H) return null;
                return this.signals[r * CONFIG.MAP_W + q];
            }

            toScreen(q, r) {
                const h = Math.sqrt(3) * CONFIG.HEX_SIZE;
                const x = CONFIG.HEX_SIZE * 1.5 * q;
                const y = h * (r + q * 0.5);
                return {
                    x: x * this.camera.zoom + this.camera.x + this.worldCanvas.width / 2,
                    y: y * this.camera.zoom + this.camera.y + this.worldCanvas.height / 2
                };
            }

            toHex(sx, sy) {
                const x = (sx - this.camera.x - this.worldCanvas.width / 2) / this.camera.zoom;
                const y = (sy - this.camera.y - this.worldCanvas.height / 2) / this.camera.zoom;
                const h = Math.sqrt(3) * CONFIG.HEX_SIZE;
                const q = Math.round((2/3) * x / CONFIG.HEX_SIZE);
                const r = Math.round((-1/3) * x / CONFIG.HEX_SIZE + y / h);
                return { q, r };
            }

            createEntity(q, r, type, owner) {
                const cell = this.get(q, r);
                if(!cell || cell.entity) return null;
                
                const template = ENTITIES[type];
                const entity = {
                    id: Date.now() + Math.random(),
                    type,
                    owner,
                    q, r,
                    ...template,
                    hp: template.composition.M + template.composition.E || 100,
                    currentStorage: { E: 0, M: 0, I: 0 }
                };
                
                cell.entity = entity;
                this.entities.push(entity);
                
                // äº§ç”Ÿåˆå§‹ä¿¡å·
                this.emitSignal(q, r, template.signal || 1, entity, false);
                
                return entity;
            }

            destroyEntity(entity) {
                const cell = this.get(entity.q, entity.r);
                if(cell) cell.entity = null;
                
                // è¿”è¿˜éƒ¨åˆ†ç‰©è´¨
                if(entity.composition) {
                    this.resources.M += Math.floor((entity.composition.M || 0) * 0.5);
                    this.resources.E += Math.floor((entity.composition.E || 0) * 0.3);
                }
                
                this.entities = this.entities.filter(e => e !== entity);
                
                // äº§ç”Ÿå¼ºä¿¡å·ï¼ˆæˆ˜æ–—/ç ´åä¿¡å·ï¼‰
                this.emitSignal(entity.q, entity.r, 50, null, false);
                
                this.log(`${entity.type} è¢«æ‘§æ¯`, 'combat');
            }

            emitSignal(q, r, strength, source, isFake) {
                // ä¿¡å·ä»¥æºç‚¹ä¸ºä¸­å¿ƒæ‰©æ•£
                const range = Math.ceil(strength / 2);
                for(let dq = -range; dq <= range; dq++) {
                    for(let dr = -range; dr <= range; dr++) {
                        const dist = (Math.abs(dq) + Math.abs(dr) + Math.abs(dq + dr)) / 2;
                        if(dist > range) continue;
                        
                        const signal = this.getSignal(q + dq, r + dr);
                        if(signal) {
                            const decay = Math.pow(CONFIG.SIGNAL_DECAY, dist);
                            const localStrength = strength * decay;
                            
                            if(localStrength > signal.strength) {
                                signal.strength = localStrength;
                                signal.source = source;
                                signal.isFake = isFake;
                                signal.age = 0;
                            }
                        }
                    }
                }
            }

            forgeSignal(q, r, strength) {
                if(this.resources.I < CONFIG.FORGE_COST_I) {
                    this.log('ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•ä¼ªé€ ä¿¡å·', 'info');
                    return;
                }
                
                this.resources.I -= CONFIG.FORGE_COST_I;
                this.emitSignal(q, r, strength, null, true);
                this.log(`åœ¨ (${q},${r}) ä¼ªé€ äº†å¼ºåº¦ ${strength} çš„ä¿¡å·`, 'signal');
            }

            setMode(mode) {
                this.mode = mode;
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('mode-' + mode)?.classList.add('active');
                
                const details = {
                    select: 'é€‰æ‹©å®ä½“æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–æ¡†é€‰å¤šä¸ªå•ä½',
                    build: `æ¶ˆè€— ${CONFIG.BUILD_COST_M}M ${CONFIG.BUILD_COST_E}E å»ºé€ å»ºç­‘ï¼ˆäº§ç”Ÿä¿¡å·ï¼‰',
                    destroy: 'ç ´ååœ°å½¢æˆ–å»ºç­‘ï¼Œå›æ”¶50%ç‰©è´¨',
                    transport: 'åˆ›å»ºè¿è¾“é˜Ÿè¿é€èµ„æºï¼ˆç§»åŠ¨äº§ç”Ÿä¿¡å·ï¼‰',
                    forge: `æ¶ˆè€— ${CONFIG.FORGE_COST_I}I ä¼ªé€ ä¿¡å·æ¬ºéª—æ•Œäºº',
                    scout: 'æ´¾é£ä¾¦å¯Ÿå•ä½ç¡®è®¤ä¿¡å·çœŸå‡'
                };
                document.getElementById('modeDetail').textContent = details[mode] || '';
            }

            setLayer(layer) {
                this.layer = layer;
                document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('layer-' + layer)?.classList.add('active');
            }

            onClick(e) {
                const rect = this.worldCanvas.getBoundingClientRect();
                const pos = this.toHex(e.clientX - rect.left, e.clientY - rect.top);
                const cell = this.get(pos.q, pos.r);
                
                if(!cell) return;
                
                switch(this.mode) {
                    case 'select':
                        this.selected = cell.entity;
                        this.updateTargetInfo(cell);
                        break;
                        
                    case 'build':
                        if(!cell.entity && this.resources.M >= CONFIG.BUILD_COST_M && this.resources.E >= CONFIG.BUILD_COST_E) {
                            this.resources.M -= CONFIG.BUILD_COST_M;
                            this.resources.E -= CONFIG.BUILD_COST_E;
                            this.createEntity(pos.q, pos.r, 'generator', 'player');
                            this.log(`å»ºé€ å®Œæˆ (${pos.q},${pos.r})`, 'info');
                        }
                        break;
                        
                    case 'destroy':
                        if(cell.entity) {
                            this.destroyEntity(cell.entity);
                        } else if(cell.matter > 0) {
                            // æŒ–æ˜åœ°å½¢
                            const extracted = Math.min(50, cell.matter);
                            cell.matter -= extracted;
                            cell.height = Math.floor(cell.matter / 10);
                            this.resources.M += extracted;
                            this.emitSignal(pos.q, pos.r, 5, null, false);
                            this.log(`æŒ–æ˜åœ°å½¢ï¼Œè·å¾— ${extracted}M`, 'info');
                        }
                        break;
                        
                    case 'forge':
                        this.forgeSignal(pos.q, pos.r, 20);
                        break;
                        
                    case 'scout':
                        this.createEntity(pos.q, pos.r, 'scout', 'player');
                        break;
                }
            }

            updateTargetInfo(cell) {
                const info = document.getElementById('targetInfo');
                let html = `<div class="stat-row"><span>åæ ‡</span><span>(${cell.q}, ${cell.r})</span></div>`;
                html += `<div class="stat-row"><span>é«˜åº¦</