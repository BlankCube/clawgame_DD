<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawCraft v5 - Legends</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a15; color: #fff; overflow: hidden; font-size: 11px; }
        #gameContainer { display: flex; height: 100vh; }
        #canvasContainer { flex: 1; position: relative; overflow: hidden; }
        #gameCanvas { cursor: grab; display: block; }
        #gameCanvas:active { cursor: grabbing; }
        #sidebar { width: 340px; background: #1a1a2e; border-left: 2px solid #e94560; padding: 10px; overflow-y: auto; }
        h1 { color: #e94560; font-size: 1.2em; }
        h2 { color: #e94560; font-size: 0.95em; margin: 10px 0 5px; }
        .section { background: rgba(255,255,255,0.05); border-radius: 5px; padding: 8px; margin-bottom: 8px; }
        .stat-row { display: flex; justify-content: space-between; padding: 4px 6px; background: rgba(0,0,0,0.3); border-radius: 3px; margin: 3px 0; font-size: 10px; }
        button { padding: 5px 8px; border: none; border-radius: 3px; background: #e94560; color: white; font-size: 10px; cursor: pointer; margin: 2px; }
        button:hover { background: #ff6b6b; }
        button:disabled { background: #444; opacity: 0.5; }
        .mini-btn { padding: 3px 6px; font-size: 9px; background: #2a4a6a; }
        .skill-btn { padding: 4px 6px; font-size: 9px; background: #6a2a6a; }
        .skill-btn.active { background: #a0f; }
        .item-slot { width: 40px; height: 40px; background: rgba(0,0,0,0.5); border: 2px solid #444; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; margin: 2px; cursor: pointer; font-size: 16px; }
        .item-slot:hover { border-color: #e94560; }
        .item-slot.equipped { border-color: #fd0; }
        .quest-item { padding: 5px; margin: 3px 0; background: rgba(255,215,0,0.1); border-left: 3px solid #fd0; border-radius: 3px; font-size: 10px; }
        .quest-item.complete { background: rgba(0,255,0,0.1); border-color: #0f0; }
        .log { max-height: 80px; overflow-y: auto; background: #0a0a15; padding: 5px; font-family: monospace; font-size: 9px; }
        .alert { color: #f44; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        .tabs { display: flex; gap: 4px; margin-bottom: 6px; }
        .tab { padding: 4px 8px; background: #333; cursor: pointer; border-radius: 3px; }
        .tab.active { background: #e94560; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .cooldown { position: relative; overflow: hidden; }
        .cooldown::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); transform: translateY(var(--cd, 0%)); transition: transform 0.1s; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer"><canvas id="gameCanvas"></canvas></div>
        <div id="sidebar">
            <h1>ğŸ¦ ClawCraft v5</h1>
            
            <div class="section">
                <div class="stat-row"><span>âš¡ èƒ½é‡</span><span id="resE">0/0</span></div>
                <div class="stat-row"><span>ğŸª™ é»„é‡‘</span><span id="resG">0</span></div>
                <div class="stat-row"><span>ğŸ’ é’»çŸ³</span><span id="resD">0</span></div>
                <div class="stat-row"><span>äººå£</span><span id="resP">0/0</span></div>
                <div class="stat-row"><span>å¾—åˆ†</span><span id="resS">0</span></div>
                <div class="stat-row alert" id="enemyAlert" style="display:none;"><span>âš ï¸ æ•Œäºº!</span><span id="enemyCount">0</span></div>
                <div style="color:#888; font-size:9px;">Tick: <span id="tickInfo">0</span> | æ³¢æ¬¡: <span id="waveInfo">1</span> | ç­‰çº§: <span id="levelInfo">1</span></div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="showTab('build')">å»ºé€ </div>
                <div class="tab" onclick="showTab('unit')">å•ä½</div>
                <div class="tab" onclick="showTab('skill')">æŠ€èƒ½</div>
                <div class="tab" onclick="showTab('item')">è£…å¤‡</div>
                <div class="tab" onclick="showTab('quest')">ä»»åŠ¡</div>
            </div>

            <div id="tab-build" class="tab-content active">
                <div class="section">
                    <h2>èµ„æºå»ºç­‘</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:3px;">
                        <button class="mini-btn" onclick="game.build('mineE')">èƒ½é‡çŸ¿ 50E</button>
                        <button class="mini-btn" onclick="game.build('mineG')">é»„é‡‘çŸ¿ 80E</button>
                        <button class="mini-btn" onclick="game.build('mineD')">é’»çŸ³çŸ¿ 200E</button>
                        <button class="mini-btn" onclick="game.build('house')">æ°‘å±… 40E</button>
                        <button class="mini-btn" onclick="game.build('storage')">ä»“åº“ 100E</button>
                    </div>
                    <h2>å†›äº‹å»ºç­‘</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:3px;">
                        <button class="mini-btn" onclick="game.build('barracks')">å…µè¥ 100E</button>
                        <button class="mini-btn" onclick="game.build('factory')">å·¥å‚ 200E</button>
                        <button class="mini-btn" onclick="game.build('tower')">é˜²å¾¡å¡” 150E</button>
                        <button class="mini-btn" onclick="game.build('wall')">åŸå¢™ 30E</button>
                        <button class="mini-btn" onclick="game.build('healer')">æ²»ç–—å¡” 250E</button>
                    </div>
                </div>
            </div>

            <div id="tab-unit" class="tab-content">
                <div class="section">
                    <div id="unitList">æ— å•ä½</div>
                    <div style="display:flex; flex-wrap:wrap; gap:3px; margin-top:5px;">
                        <button onclick="game.spawn('warrior')">æˆ˜å£« 30E</button>
                        <button onclick="game.spawn('archer')">å¼“ç®­æ‰‹ 40E</button>
                        <button onclick="game.spawn('tank')">å¦å…‹ 50E</button>
                        <button onclick="game.spawn('mage')">æ³•å¸ˆ 60E</button>
                        <button onclick="game.spawn('healer')">æ²»ç–—å¸ˆ 70E</button>
                        <button onclick="game.spawn('worker')">å·¥äºº 20E</button>
                    </div>
                </div>
            </div>

            <div id="tab-skill" class="tab-content">
                <div class="section">
                    <h2>ä¸»åŠ¨æŠ€èƒ½</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:3px;">
                        <button class="skill-btn" id="skill-heal" onclick="game.castSkill('heal')">æ²»ç–— 50E</button>
                        <button class="skill-btn" id="skill-fireball" onclick="game.castSkill('fireball')">ç«çƒ 80E</button>
                        <button class="skill-btn" id="skill-buff" onclick="game.castSkill('buff')">å¼ºåŒ– 100E</button>
                        <button class="skill-btn" id="skill-teleport" onclick="game.castSkill('teleport')">ä¼ é€ 150E</button>
                    </div>
                    <h2>è¢«åŠ¨æŠ€èƒ½</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:3px;">
                        <button class="mini-btn" onclick="game.buyPassive('regen', 200)">ç”Ÿå‘½æ¢å¤ 200G</button>
                        <button class="mini-btn" onclick="game.buyPassive('speed', 300)">é€Ÿåº¦æå‡ 300G</button>
                        <button class="mini-btn" onclick="game.buyPassive('crit', 500)">æš´å‡» 500G</button>
                    </div>
                </div>
            </div>

            <div id="tab-item" class="tab-content">
                <div class="section">
                    <h2>è£…å¤‡æ </h2>
                    <div id="equipment">
                        <div class="item-slot" onclick="game.equipItem(0)" id="slot-0">ğŸ—¡ï¸</div>
                        <div class="item-slot" onclick="game.equipItem(1)" id="slot-1">ğŸ›¡ï¸</div>
                        <div class="item-slot" onclick="game.equipItem(2)" id="slot-2">ğŸ‘‘</div>
                        <div class="item-slot" onclick="game.equipItem(3)" id="slot-3">ğŸ’</div>
                    </div>
                    <h2>å•†åº—</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:3px;">
                        <button class="mini-btn" onclick="game.buyItem('sword', 100)">é“å‰‘ +5æ”» 100G</button>
                        <button class="mini-btn" onclick="game.buyItem('shield', 100)">ç›¾ç‰Œ +5é˜² 100G</button>
                        <button class="mini-btn" onclick="game.buyItem('armor', 200)">é“ ç”² +10é˜² 200G</button>
                        <button class="mini-btn" onclick="game.buyItem('ring', 500)">é­”æˆ’ +å…¨å±æ€§ 500G</button>
                    </div>
                </div>
            </div>

            <div id="tab-quest" class="tab-content">
                <div class="section">
                    <div id="questList"></div>
                    <button onclick="game.refreshQuests()" style="margin-top:10px; width:100%;">åˆ·æ–°ä»»åŠ¡ 50G</button>
                </div>
            </div>

            <div class="section">
                <div id="hexDetail">ç‚¹å‡»åœ°å›¾</div>
            </div>

            <div class="section">
                <div style="display:flex; flex-wrap:wrap; gap:3px;">
                    <button onclick="game.speed = game.speed==1?5:1">åŠ é€Ÿ</button>
                    <button onclick="game.save()">ä¿å­˜</button>
                    <button onclick="game.load()">åŠ è½½</button>
                    <button onclick="game.reset()">é‡ç½®</button>
                </div>
            </div>

            <div class="section"><div class="log" id="log"></div></div>
        </div>
    </div>

    <script>
        function showTab(n) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-'+n).classList.add('active');
        }

        const CONFIG = {
            MAP_W: 35, MAP_H: 35, HEX_SIZE: 24,
            TICK_RATE: 500, MAX_UNITS: 25, MAX_POP: 60,
            START_E: 600, START_G: 150, START_D: 0,
            ENEMY_RATE: 12, WAVE_RATE: 250,
            SKILL_COOLDOWN: 50
        };

        const UNITS = {
            warrior: { n: 'æˆ˜å£«', atk: 18, def: 6, hp: 120, move: 2, range: 1, cost: 30 },
            archer: { n: 'å¼“ç®­æ‰‹', atk: 14, def: 4, hp: 80, move: 2, range: 4, cost: 40 },
            tank: { n: 'å¦å…‹', atk: 10, def: 12, hp: 180, move: 1, range: 1, cost: 50 },
            mage: { n: 'æ³•å¸ˆ', atk: 25, def: 3, hp: 60, move: 2, range: 3, cost: 60, magic: true },
            healer: { n: 'æ²»ç–—å¸ˆ', atk: 5, def: 4, hp: 70, move: 2, range: 2, cost: 70, heal: 20 },
            worker: { n: 'å·¥äºº', atk: 6, def: 3, hp: 70, move: 2, range: 1, cost: 20, gather: true }
        };

        const BUILDINGS = {
            mineE: { n: 'èƒ½é‡çŸ¿', c: 50, e: 10 },
            mineG: { n: 'é»„é‡‘çŸ¿', c: 80, g: 4 },
            mineD: { n: 'é’»çŸ³çŸ¿', c: 200, d: 1 },
            house: { n: 'æ°‘å±…', c: 40, pop: 5 },
            storage: { n: 'ä»“åº“', c: 100, storage: 1000 },
            barracks: { n: 'å…µè¥', c: 100 },
            factory: { n: 'å·¥å‚', c: 200 },
            tower: { n: 'é˜²å¾¡å¡”', c: 150, atk: 25, range: 5 },
            wall: { n: 'åŸå¢™', c: 30, hp: 400 },
            healer: { n: 'æ²»ç–—å¡”', c: 250, heal: 10, range: 4 }
        };

        const SKILLS = {
            heal: { n: 'æ²»ç–—', cost: 50, cd: 30, effect: 'healAll' },
            fireball: { n: 'ç«çƒ', cost: 80, cd: 40, effect: 'damageArea' },
            buff: { n: 'å¼ºåŒ–', cost: 100, cd: 60, effect: 'buffAll' },
            teleport: { n: 'ä¼ é€', cost: 150, cd: 100, effect: 'teleport' }
        };

        const ITEMS = {
            sword: { n: 'é“å‰‘', icon: 'ğŸ—¡ï¸', atk: 5, def: 0, hp: 0 },
            shield: { n: 'ç›¾ç‰Œ', icon: 'ğŸ›¡ï¸', atk: 0, def: 5, hp: 20 },
            armor: { n: 'é“ ç”²', icon: 'ğŸ‘‘', atk: 0, def: 10, hp: 50 },
            ring: { n: 'é­”æˆ’', icon: 'ğŸ’', atk: 3, def: 3, hp: 30 }
        };

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.camera = { x: 0, y: 0, zoom: 1 };
                this.tick = 0; this.speed = 1; this.wave = 1; this.level = 1;
                this.tech = {}; this.passives = {}; this.enemies = [];
                this.items = []; this.equipped = [null, null, null, null];
                this.quests = []; this.skillCDs = {};
                this.stats = { kills: 0, builds: 0, quests: 0 };
                this.achievements = new Set();
                this.particles = [];
                this.reset(); this.setup(); this.start();
                this.generateQuests();
            }

            reset() {
                this.energy = CONFIG.START_E; this.maxE = 1000;
                this.gold = CONFIG.START_G; this.diamond = CONFIG.START_D;
                this.pop = 0; this.maxPop = 10;
                this.units = []; this.enemies = [];
                this.selected = null; this.mode = null; this.score = 0;
                this.skillCDs = {};
                
                this.grid = [];
                for(let q = 0; q < CONFIG.MAP_W; q++) {
                    for(let r = 0; r < CONFIG.MAP_H; r++) {
                        const noise = Math.sin(q * 0.15) * Math.cos(r * 0.15) + Math.sin(q * 0.05 + r * 0.05) * 0.5;
                        this.grid.push({
                            q, r, x: 0, y: 0,
                            h: Math.floor((noise + 1.5) * 25),
                            e: Math.random() < 0.12 ? Math.floor(Math.random() * 150 + 50) : 0,
                            g: Math.random() < 0.08 ? Math.floor(Math.random() * 80 + 20) : 0,
                            d: Math.random() < 0.03 ? Math.floor(Math.random() * 30 + 10) : 0,
                            b: null, u: null
                        });
                    }
                }
                const center = this.get(17, 17);
                if(center) { center.b = { t: 'base', n: 'åŸºåœ°', hp: 1500, maxHp: 1500 }; this.base = center; }
            }

            setup() {
                const rs = () => { this.canvas.width = this.canvas.parentElement.clientWidth; this.canvas.height = this.canvas.parentElement.clientHeight; };
                window.addEventListener('resize', rs); rs();
                let d = false, l = { x: 0, y: 0 };
                this.canvas.addEventListener('mousedown', e => { d = true; l = { x: e.clientX, y: e.clientY }; });
                this.canvas.addEventListener('mousemove', e => { if(d) { this.camera.x += e.clientX - l.x; this.camera.y += e.clientY - l.y; l = { x: e.clientX, y: e.clientY }; } });
                this.canvas.addEventListener('mouseup', () => d = false);
                this.canvas.addEventListener('wheel', e => { e.preventDefault(); const f = e.deltaY > 0 ? 0.9 : 1.1; this.camera.zoom = Math.max(0.3, Math.min(3, this.camera.zoom * f)); });
                this.canvas.addEventListener('click', e => this.onClick(e));
                this.calcPos();
            }

            calcPos() { const h = Math.sqrt(3) * CONFIG.HEX_SIZE; for(const c of this.grid) { c.x = CONFIG.HEX_SIZE * 1.5 * c.q; c.y = h * (c.r + c.q * 0.5); } }
            get(q, r) { return this.grid.find(c => c.q === q && c.r === r); }
            toScreen(q, r) { const h = Math.sqrt(3) * CONFIG.HEX_SIZE; return { x: (CONFIG.HEX_SIZE * 1.5 * q) * this.camera.zoom + this.camera.x + this.canvas.width / 2, y: (h * (r + q * 0.5)) * this.camera.zoom + this.camera.y + this.canvas.height / 2 }; }
            toHex(sx, sy) { const x = (sx - this.camera.x - this.canvas.width / 2) / this.camera.zoom; const y = (sy - this.camera.y - this.canvas.height / 2) / this.camera.zoom; const h = Math.sqrt(3) * CONFIG.HEX_SIZE; return { q: Math.round((2 / 3) * x / CONFIG.HEX_SIZE), r: Math.round((-1 / 3) * x / CONFIG.HEX_SIZE + y / h) }; }

            build(t) { this.mode = 'build:' + t; this.log('å»ºé€ : ' + BUILDINGS[t].n); }
            spawn(t) {
                const u = UNITS[t];
                if(this.energy < u.cost || this.pop >= this.maxPop) { this.log(this.pop >= this.maxPop ? 'äººå£ä¸è¶³' : 'èƒ½é‡ä¸è¶³'); return; }
                this.energy -= u.cost; this.pop++;
                const stats = this.getUnitStats(u);
                const unit = { id: Date.now(), type: t, t: 'player', q: this.base.q, r: this.base.r, ...stats, maxHp: stats.hp, carrying: 0, buffs: {} };
                this.units.push(unit); this.get(unit.q, unit.r).u = unit;
                this.log(u.n + 'å·²è®­ç»ƒ');
            }

            getUnitStats(base) {
                const itemBonus = this.getItemBonus();
                return {
                    atk: base.atk + itemBonus.atk,
                    def: base.def + itemBonus.def,
                    hp: base.hp + itemBonus.hp,
                    move: base.move,
                    range: base.range
                };
            }

            getItemBonus() {
                let atk = 0, def = 0, hp = 0;
                for(const item of this.equipped) { if(item) { atk += item.atk || 0; def += item.def || 0; hp += item.hp || 0; } }
                return { atk, def, hp };
            }

            spawnEnemy() {
                const edges = this.grid.filter(c => c.q === 0 || c.q === CONFIG.MAP_W - 1 || c.r === 0 || c.r === CONFIG.MAP_H - 1);
                const s = edges[Math.floor(Math.random() * edges.length)];
                if(!s || s.b?.t === 'base') return;
                const bonus = this.wave * 5 + this.level * 2;
                const types = ['warrior', 'archer', 'tank', 'mage'];
                const type = types[Math.floor(Math.random() * types.length)];
                const base = UNITS[type];
                this.enemies.push({ id: Date.now(), type: type, t: 'enemy', q: s.q, r: s.r, atk: base.atk + bonus, def: base.def, hp: base.hp + bonus * 2, maxHp: base.hp + bonus * 2, move: base.move, range: base.range });
            }

            castSkill(s) {
                const skill = SKILLS[s];
                if(this.skillCDs[s] > 0 || this.energy < skill.cost) { this.log('æŠ€èƒ½å†·å´ä¸­æˆ–èƒ½é‡ä¸è¶³'); return; }
                this.energy -= skill.cost;
                this.skillCDs[s] = skill.cd;
                
                switch(skill.effect) {
                    case 'healAll':
                        for(const u of this.units) { u.hp = Math.min(u.maxHp, u.hp + 50); this.addParticle(u.q, u.r, '+50', '#0f0'); }
                        this.log('å…¨ä½“æ²»ç–—!');
                        break;
                    case 'damageArea':
                        for(const e of this.enemies) { e.hp -= 30; this.addParticle(e.q, e.r, '-30', '#f80'); }
                        this.log('ç«çƒæœ¯!');
                        break;
                    case 'buffAll':
                        for(const u of this.units) { u.buffs.power = 50; }
                        this.log('å…¨ä½“å¼ºåŒ–!');
                        break;
                    case 'teleport':
                        this.mode = 'teleport';
                        this.log('é€‰æ‹©ä¼ é€ç›®æ ‡');
                        return;
                }
            }

            buyPassive(p, cost) {
                if(this.passives[p] || this.gold < cost) return;
                this.gold -= cost;
                this.passives[p] = true;
                this.log('è¢«åŠ¨æŠ€èƒ½: ' + p);
            }

            buyItem(item, cost) {
                if(this.gold < cost) return;
                this.gold -= cost;
                this.items.push({ ...ITEMS[item], id: Date.now() });
                this.log('è´­ä¹°: ' + ITEMS[item].n);
            }

            equipItem(slot) {
                if(this.items.length === 0) return;
                const item = this.items[0];
                this.equipped[slot] = item;
                this.items = this.items.slice(1);
                document.getElementById('slot-' + slot).textContent = item.icon;
                document.getElementById('slot-' + slot).classList.add('equipped');
                this.log('è£…å¤‡: ' + item.n);
            }

            generateQuests() {
                this.quests = [
                    { id: 1, name: 'åˆæˆ˜å‘Šæ·', desc: 'å‡»æ€5ä¸ªæ•Œäºº', target: 'kill', count: 5, current: 0, reward: 100, complete: false },
                    { id: 2, name: 'èµ„æºæ”¶é›†', desc: 'é‡‡é›†500èƒ½é‡', target: 'gather', count: 500, current: 0, reward: 150, complete: false },
                    { id: 3, name: 'åŸå¸‚å»ºè®¾', desc: 'å»ºé€ 10ä¸ªå»ºç­‘', target: 'build', count: 10, current: 0, reward: 200, complete: false }
                ];
            }

            refreshQuests() {
                if(this.gold < 50) return;
                this.gold -= 50;
                this.generateQuests();
                this.log('ä»»åŠ¡å·²åˆ·æ–°');
            }

            checkQuests(type, amount) {
                for(const q of this.quests) {
                    if(!q.complete && q.target === type) {
                        q.current += amount;
                        if(q.current >= q.count) {
                            q.complete = true;
                            this.gold += q.reward;
                            this.stats.quests++;
                            this.log('ä»»åŠ¡å®Œæˆ: ' + q.name + ' +' + q.reward + 'G');
                        }
                    }
                }
                this.updateQuests();
            }

            updateQuests() {
                const list = document.getElementById('questList');
                list.innerHTML = this.quests.map(q => `<div class="quest-item ${q.complete ? 'complete' : ''}">
                    <strong>${q.name}</strong>: ${q.desc}<br/>
                    è¿›åº¦: ${q.current}/${q.count} | å¥–åŠ±: ${q.reward}G
                </div>`).join('');
            }

            onClick(e) {
                const r = this.canvas.getBoundingClientRect();
                const p = this.toHex(e.clientX - r.left, e.clientY - r.top);
                const c = this.get(p.q, p.r);
                if(!c) return;

                if(this.mode?.startsWith('build:')) {
                    const t = this.mode.split(':')[1];
                    const b = BUILDINGS[t];
                    if(this.energy >= b.c && !c.b) {
                        this.energy -= b.c; c.b = { t, ...b, hp: b.hp || 100 };
                        this.stats.builds++; this.score += 10;
                        this.checkQuests('build', 1);
                        this.log('å»ºé€ : ' + b.n);
                    }
                    this.mode = null; return;
                }

                if(this.mode === 'teleport' && this.selected) {
                    this.get(this.selected.q, this.selected.r).u = null;
                    this.selected.q = c.q; this.selected.r