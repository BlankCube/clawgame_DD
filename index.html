<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawCraft v3 - War</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a15; color: #fff; overflow: hidden; font-size: 11px; }
        #gameContainer { display: flex; height: 100vh; }
        #canvasContainer { flex: 1; position: relative; overflow: hidden; }
        #gameCanvas { cursor: grab; display: block; }
        #gameCanvas:active { cursor: grabbing; }
        #sidebar { width: 300px; background: #1a1a2e; border-left: 2px solid #e94560; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        h1 { color: #e94560; font-size: 1.2em; margin-bottom: 6px; }
        h2 { color: #e94560; font-size: 0.95em; margin-bottom: 5px; }
        .section { background: rgba(255,255,255,0.05); border-radius: 5px; padding: 8px; }
        .stat-row { display: flex; justify-content: space-between; margin: 3px 0; padding: 4px 6px; background: rgba(0,0,0,0.3); border-radius: 3px; font-size: 10px; }
        .res-bar { height: 6px; background: #333; border-radius: 3px; margin-top: 3px; overflow: hidden; }
        .res-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        button { padding: 5px 8px; border: none; border-radius: 3px; background: #e94560; color: white; font-size: 10px; cursor: pointer; margin: 2px; }
        button:hover { background: #ff6b6b; }
        button:disabled { background: #444; opacity: 0.5; }
        button.active { background: #4a9; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 3px; }
        .mini-btn { padding: 3px 6px; font-size: 9px; background: #2a4a6a; }
        .tech-btn { padding: 4px 6px; font-size: 9px; background: #4a2a6a; }
        .tech-btn.unlocked { background: #4a9; }
        .log { max-height: 60px; overflow-y: auto; background: #0a0a15; border-radius: 3px; padding: 5px; font-family: monospace; font-size: 9px; }
        .alert { color: #f44; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        .tabs { display: flex; gap: 4px; margin-bottom: 6px; }
        .tab { padding: 4px 8px; background: #333; cursor: pointer; border-radius: 3px; }
        .tab.active { background: #e94560; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer"><canvas id="gameCanvas"></canvas></div>
        <div id="sidebar">
            <h1>ü¶û ClawCraft v3</h1>
            
            <div class="section">
                <div class="stat-row"><span>‚ö° ËÉΩÈáè</span><span id="resE">0/0</span></div>
                <div class="res-bar"><div class="res-fill" id="barE" style="width:0%; background:#fd0;"></div></div>
                <div class="stat-row" style="margin-top:6px;"><span>ü™ô ÈªÑÈáë</span><span id="resG">0</span></div>
                <div class="stat-row"><span>üë§ Âçï‰Ωç</span><span id="resU">0/0</span></div>
                <div class="stat-row alert" id="enemyAlert" style="display:none;"><span>‚ö†Ô∏è Êïå‰∫∫!</span><span id="enemyCount">0</span></div>
                <div style="color:#888; font-size:9px;">Tick: <span id="tickInfo">0</span></div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="showTab('build')">Âª∫ÈÄ†</div>
                <div class="tab" onclick="showTab('tech')">ÁßëÊäÄ</div>
                <div class="tab" onclick="showTab('unit')">Âçï‰Ωç</div>
            </div>

            <div id="tab-build" class="tab-content active">
                <div class="section">
                    <div class="btn-group">
                        <button class="mini-btn" onclick="game.setBuild('mineE')">ËÉΩÈáèÁüø 50E</button>
                        <button class="mini-btn" onclick="game.setBuild('mineG')">ÈªÑÈáëÁüø 80E</button>
                        <button class="mini-btn" onclick="game.setBuild('tower')">Èò≤Âæ°Â°î 150E</button>
                        <button class="mini-btn" onclick="game.setBuild('barracks')">ÂÖµËê• 100E</button>
                    </div>
                    <button onclick="game.cancelBuild()" style="margin-top:5px; width:100%;">ÂèñÊ∂à</button>
                </div>
            </div>

            <div id="tab-tech" class="tab-content">
                <div class="section">
                    <div class="btn-group">
                        <button class="tech-btn" id="techAtk" onclick="game.unlockTech('atk',100)">ÊîªÂáª+20% 100G</button>
                        <button class="tech-btn" id="techDef" onclick="game.unlockTech('def',100)">Èò≤Âæ°+20% 100G</button>
                        <button class="tech-btn" id="techSpd" onclick="game.unlockTech('spd',150)">ÈÄüÂ∫¶+1 150G</button>
                    </div>
                </div>
            </div>

            <div id="tab-unit" class="tab-content">
                <div class="section">
                    <div id="unitList">Êó†Âçï‰Ωç</div>
                    <div class="btn-group" style="margin-top:6px;">
                        <button onclick="game.spawnUnit()">ÁîüÊàê 30E</button>
                        <button onclick="game.toggleMove()">ÁßªÂä®</button>
                        <button onclick="game.toggleAttack()">ÊîªÂáª</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div id="hexDetail">ÁÇπÂáªÂú∞Âõæ</div>
            </div>

            <div class="section">
                <div class="btn-group">
                    <button onclick="game.speed = game.speed === 1 ? 3 : 1">Âä†ÈÄü</button>
                    <button onclick="game.save()">‰øùÂ≠ò</button>
                    <button onclick="game.load()">Âä†ËΩΩ</button>
                    <button onclick="game.reset()">ÈáçÁΩÆ</button>
                </div>
            </div>

            <div class="section"><div class="log" id="log"></div></div>
        </div>
    </div>

    <script>
        function showTab(n) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-'+n).classList.add('active');
        }

        const CONFIG = { MAP_W: 20, MAP_H: 20, HEX_SIZE: 28, TICK_RATE: 1000, MAX_UNITS: 10, START_E: 300, START_G: 50, ENEMY_RATE: 20 };
        const BUILD = { mineE: {n:'ËÉΩÈáèÁüø',c:50,e:5}, mineG: {n:'ÈªÑÈáëÁüø',c:80,g:2}, tower: {n:'Èò≤Âæ°Â°î',c:150,atk:15}, barracks: {n:'ÂÖµËê•',c:100} };

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.camera = {x:0,y:0,zoom:1};
                this.tick = 0; this.speed = 1;
                this.tech = {}; this.enemies = [];
                this.reset(); this.setup(); this.start();
            }

            reset() {
                this.energy = CONFIG.START_E; this.gold = CONFIG.START_G; this.maxE = 1000;
                this.units = []; this.enemies = []; this.selected = null;
                this.mode = null;
                this.grid = [];
                for(let q=0; q<CONFIG.MAP_W; q++) {
                    for(let r=0; r<CONFIG.MAP_H; r++) {
                        this.grid.push({q,r,x:0,y:0,h:Math.floor(Math.random()*60+20),e:Math.random()<0.2?Math.floor(Math.random()*200):0,g:Math.random()<0.1?Math.floor(Math.random()*100):0,b:null,u:null});
                    }
                }
                const c = this.get(10,10);
                if(c) { c.b = {t:'base',n:'Âü∫Âú∞',hp:500}; this.base = c; }
            }

            setup() {
                const rs = () => { this.canvas.width = this.canvas.parentElement.clientWidth; this.canvas.height = this.canvas.parentElement.clientHeight; };
                window.addEventListener('resize', rs); rs();
                let d=false,l={x:0,y:0};
                this.canvas.addEventListener('mousedown',e=>{d=true;l={x:e.clientX,y:e.clientY}});
                this.canvas.addEventListener('mousemove',e=>{if(d){this.camera.x+=e.clientX-l.x;this.camera.y+=e.clientY-l.y;l={x:e.clientX,y:e.clientY};}});
                this.canvas.addEventListener('mouseup',()=>d=false);
                this.canvas.addEventListener('wheel',e=>{e.preventDefault();this.camera.zoom*=e.deltaY>0?0.9:1.1;this.camera.zoom=Math.max(0.3,Math.min(3,this.camera.zoom));});
                this.canvas.addEventListener('click',e=>this.onClick(e));
                this.calcPos();
            }

            calcPos() {
                const h = Math.sqrt(3)*CONFIG.HEX_SIZE;
                for(const c of this.grid) { c.x = CONFIG.HEX_SIZE*1.5*c.q; c.y = h*(c.r+c.q*0.5); }
            }

            get(q,r) { return this.grid.find(c=>c.q===q&&c.r===r); }

            toScreen(q,r) {
                const h = Math.sqrt(3)*CONFIG.HEX_SIZE;
                return { x: (CONFIG.HEX_SIZE*1.5*q)*this.camera.zoom+this.camera.x+this.canvas.width/2, y: (h*(r+q*0.5))*this.camera.zoom+this.camera.y+this.canvas.height/2 };
            }

            toHex(sx,sy) {
                const x = (sx-this.camera.x-this.canvas.width/2)/this.camera.zoom;
                const y = (sy-this.camera.y-this.canvas.height/2)/this.camera.zoom;
                const h = Math.sqrt(3)*CONFIG.HEX_SIZE;
                return { q: Math.round((2/3)*x/CONFIG.HEX_SIZE), r: Math.round((-1/3)*x/CONFIG.HEX_SIZE+y/h) };
            }

            setBuild(t) { this.mode = 'build:'+t; }
            cancelBuild() { this.mode = null; }
            toggleMove() { this.mode = this.mode==='move'?null:'move'; }
            toggleAttack() { this.mode = this.mode==='attack'?null:'attack'; }

            spawnUnit() {
                if(this.energy<30 || this.units.length>=CONFIG.MAX_UNITS) return;
                const s = this.base;
                this.energy -= 30;
                const u = { id: Date.now(), t:'player', q:s.q, r:s.r, hp:100, maxHp:100, atk:10*(this.tech.atk?1.2:1), def:5*(this.tech.def?1.2:1), move:2+(this.tech.spd?1:0) };
                this.units.push(u); this.get(u.q,u.r).u = u;
                this.log('Âçï‰ΩçÂ∑≤ÁîüÊàê');
            }

            spawnEnemy() {
                const edge = this.grid.filter(c=>c.q===0||c.q===CONFIG.MAP_W-1||c.r===0||c.r===CONFIG.MAP_H-1);
                const s = edge[Math.floor(Math.random()*edge.length)];
                if(!s||s.b?.t==='base') return;
                const hp = 50 + Math.floor(this.tick/100)*5;
                this.enemies.push({ id: Date.now(), t:'enemy', q:s.q, r:s.r, hp, maxHp:hp, atk:8+Math.floor(this.tick/100), def:2, move:2 });
            }

            unlockTech(t,c) {
                if(this.tech[t] || this.gold<c) return;
                this.gold -= c; this.tech[t] = true;
                document.getElementById('tech'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.add('unlocked');
                this.log('ÁßëÊäÄ: '+t);
            }

            onClick(e) {
                const r = this.canvas.getBoundingClientRect();
                const p = this.toHex(e.clientX-r.left, e.clientY-r.top);
                const c = this.get(p.q, p.r);
                if(!c) return;

                if(this.mode?.startsWith('build:')) {
                    const t = this.mode.split(':')[1];
                    const b = BUILD[t];
                    if(this.energy>=b.c && !c.b) { this.energy -= b.c; c.b = {t,...b,hp:100}; this.log('Âª∫ÈÄ†: '+b.n); }
                    this.mode = null; return;
                }

                if(this.mode==='move' && this.selected) {
                    const u = this.selected;
                    const dist = (Math.abs(u.q-c.q)+Math.abs(u.r-c.r))/2;
                    if(dist<=u.move && !c.u) { this.get(u.q,u.r).u = null; u.q = c.q; u.r = c.r; c.u = u; }
                    this.mode = null; return;
                }

                if(this.mode==='attack' && this.selected) {
                    const u = this.selected;
                    const tgt = c.u || this.enemies.find(e=>e.q===c.q&&e.r===c.r);
                    if(tgt && tgt.t!==u.t) {
                        const dist = (Math.abs(u.q-tgt.q)+Math.abs(u.r-tgt.r))/2;
                        if(dist<=1) { this.fight(u,tgt); }
                    }
                    this.mode = null; return;
                }

                if(c.u?.t==='player') this.selected = c.u;
                this.updateDetail(c);
            }

            fight(a,d) {
                const dmg = Math.max(1, Math.floor(a.atk - d.def));
                d.hp -= dmg;
                if(d.hp<=0) {
                    if(d.t==='enemy') { this.enemies = this.enemies.filter(e=>e!==d); this.gold += 10; this.log('ÂáªÊùÄ +10G'); }
                    else { this.units = this.units.filter(u=>u!==d); this.get(d.q,d.r).u = null; this.log('Âçï‰ΩçÈòµ‰∫°'); }
                }
            }

            update() {
                this.tick++;
                for(const c of this.grid) {
                    if(c.b?.e && this.energy<this.maxE) this.energy = Math.min(this.maxE, this.energy + c.b.e);
                    if(c.b?.g) this.gold += c.b.g;
                }

                if(this.tick % CONFIG.ENEMY_RATE === 0) this.spawnEnemy();

                for(const e of this.enemies) {
                    let tgt = null, best = Infinity;
                    for(const u of this.units) { const d = (Math.abs(e.q-u.q)+Math.abs(e.r-u.r))/2; if(d<best) { best=d; tgt=u; } }
                    if(this.base) { const d = (Math.abs(e.q-this.base.q)+Math.abs(e.r-this.base.r))/2; if(d<best) tgt = this.base; }
                    
                    if(tgt) {
                        const dist = (Math.abs(e.q-tgt.q)+Math.abs(e.r-tgt.r))/2;
                        if(dist<=1) { this.fight(e,tgt); }
                        else {
                            const dx = Math.sign(tgt.q-e.q), dy = Math.sign(tgt.r-e.r);
                            const n = this.get(e.q+dx, e.r+dy);
                            if(n && !n.u && !n.b) { e.q += dx; e.r += dy; }
                        }
                    }
                }

                this.updateUI();
            }

            updateUI() {
                document.getElementById('resE').textContent = Math.floor(this.energy)+'/'+this.maxE;
                document.getElementById('barE').style.width = (this.energy/this.maxE*100)+'%';
                document.getElementById('resG').textContent = Math.floor(this.gold);
                document.getElementById('resU').textContent = this.units.length+'/'+CONFIG.MAX_UNITS;
                document.getElementById('tickInfo').textContent = this.tick;
                document.getElementById('enemyAlert').style.display = this.enemies.length>0?'flex':'none';
                document.getElementById('enemyCount').textContent = this.enemies.length;

                const list = document.getElementById('unitList');
                let html = '';
                for(const u of this.units) html += `<div style="padding:3px; margin:2px 0; background:${u===this.selected?'#e94560':'rgba(255,255,255,0.1)'}; border-radius:3px; cursor:pointer; font-size:9px;" onclick="game.selected=game.units.find(x=>x.id===${u.id})">Âèã #${u.id.toString().slice(-4)} HP:${u.hp}</div>`;
                for(const e of this.enemies) html += `<div style="padding:3px; margin:2px 0; background:rgba(244,67,54,0.3); border-radius:3px; font-size:9px;">Êïå #${e.id.toString().slice(-4)} HP:${e.hp}</div>`;
                list.innerHTML = html || 'Êó†Âçï‰Ωç';
            }

            updateDetail(c) {
                let h = `<div class="stat-row"><span>ÂùêÊ†á</span><span>(${c.q},${c.r})</span></div>`;
                h += `<div class="stat-row"><span>È´òÂ∫¶</span><span>${c.h}</span></div>`;
                if(c.e) h += `<div class="stat-row"><span>ËÉΩÈáè</span><span>${c.e}</span></div>`;
                if(c.g) h += `<div class="stat-row"><span>ÈªÑÈáë</span><span>${c.g}</span></div>`;
                if(c.b) h += `<div class="stat-row"><span>Âª∫Á≠ë</span><span>${c.b.n}</span></div>`;
                if(c.u) h += `<div class="stat-row"><span>Âçï‰Ωç</span><span>HP:${c.u.hp}</span></div>`;
                document.getElementById('hexDetail').innerHTML = h;
            }

            draw() {
                this.ctx.fillStyle = '#0a0a15';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                for(const c of this.grid) {
                    const p = this.toScreen(c.q, c.r);
                    const s = CONFIG.HEX_SIZE * this.camera.zoom;
                    if(p.x<-s || p.x>this.canvas.width+s || p.y<-s || p.y>this.canvas.height+s) continue;

                    this.ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        const a = (Math.PI/3)*i;
                        const x = p.x + s*Math.cos(a);
                        const y = p.y + s*Math.sin(a);
                        if(i===0) this.ctx.moveTo(x,y); else this.ctx.lineTo(x,y);
                    }
                    this.ctx.closePath();
                    this.ctx.fillStyle = `rgb(${30+c.h},${50+c.h/2},${30+c.h/3})`;
                    this.ctx.fill();
                    if(c.e) { this.ctx.fillStyle = `rgba(255,215,0,${0.2+c.e/500})`; this.ctx.fill(); }
                    if(c.b) {
                        const colors = { base: '#e94560', mineE: '#fd0', mineG: '#fa0', tower: '#f44', barracks: '#4a9' };
                        this.ctx.fillStyle = colors[c.b.t] || '#fff';
                        this.ctx.beginPath(); this.ctx.arc(p.x, p.y, s*0.5, 0, Math.PI*2); this.ctx.fill();
                    }
                    this.ctx.strokeStyle = '#333'; this.ctx.lineWidth = 1; this.ctx.stroke();
                }

                for(const u of this.units) {
                    const p = this.toScreen(u.q, u.r);
                    const s = CONFIG.HEX_SIZE * this.camera.zoom * 0.4;
                    this.ctx.fillStyle = u===this.selected ? '#0f0' : '#4a9';
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, s, 0, Math.PI*2); this.ctx.fill();
                }

                for(const e of this.enemies) {
                    const p = this.toScreen(e.q, e.r);
                    const s = CONFIG.HEX_SIZE * this.camera.zoom * 0.4;
                    this.ctx.fillStyle = '#f44';
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, s, 0, Math.PI*2); this.ctx.fill();
                }
            }

            start() {
                setInterval(()=>{for(let i=0;i<this.speed;i++)this.update();}, CONFIG.TICK_RATE);
                const lp = ()=>{this.draw(); requestAnimationFrame(lp);};
                lp();
            }

            log(m) {
                const l = document.getElementById('log');
                const e = document.createElement('div');
                e.style.cssText = 'padding:1px 0; border-bottom:1px solid #1a1a2e;';
                e.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
                l.insertBefore(e, l.firstChild);
                if(l.children.length>15) l.lastChild.remove();
            }

            save() { localStorage.setItem('cc3', JSON.stringify({tick:this.tick, energy:this.energy, gold:this.gold, units:this.units, enemies:this.enemies, grid:this.grid.map(c=>({q:c.q,r:c.r,h:c.h,e:c.e,g:c.g,b:c.b}))})); this.log('Â∑≤‰øùÂ≠ò'); }
            load() {
                const d = localStorage.getItem('cc3');
                if(!d) return;
                const data = JSON.parse(d);
                this.tick = data.tick || 0; this.energy = data.energy || 0; this.gold = data.gold || 0;
                this.units = data.units || []; this.enemies = data.enemies || [];
                for(const c of data.grid || []) { const cell = this.get(c.q, c.r); if(cell) { cell.h = c.h; cell.e = c.e; cell.g = c.g; cell.b = c.b; } }
                this.base = this.grid.find(c=>c.b?.t==='base');
                this.log('Â∑≤Âä†ËΩΩ');
            }
            reset() { if(confirm('ÈáçÁΩÆ?')) { this.reset(); this.log('Â∑≤ÈáçÁΩÆ'); } }
        }

        const game = new Game();
    </script>
</body>
</html>
